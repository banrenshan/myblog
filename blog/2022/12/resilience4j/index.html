<!doctype html><html class=position-relative itemscope itemtype=https://schema.org/WebPage lang=zh-hans data-bs-theme=auto data-palette=purple><head><script src=/myblog/assets/init/bundle.min.28cde6c3afc388a3d86d2a990679f9c3f5cb038fc7596a13ea18a4a0ed45c5f0.js integrity="sha256-KM3mw6/DiKPYbSqZBnn5w/XLA4/HWWoT6hikoO1FxfA=" crossorigin=anonymous></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Resilience4j -</title><link rel=icon href=/myblog/favicon_hucccd9e706a19cc8586335b155a80c266_43860_16x16_resize_q75_h2_box_2.webp sizes=16x16 type=image/webp><link rel=icon href=/myblog/favicon_hucccd9e706a19cc8586335b155a80c266_43860_32x32_resize_q75_h2_box_2.webp sizes=32x32 type=image/webp><link rel=icon href=/myblog/favicon_hucccd9e706a19cc8586335b155a80c266_43860_150x150_resize_q75_h2_box_2.webp sizes=150x150 type=image/webp><link rel=apple-touch-icon href=/myblog/favicon_hucccd9e706a19cc8586335b155a80c266_43860_180x180_resize_q75_h2_box_2.webp sizes=180x180 type=image/webp><link rel=icon href=/myblog/favicon_hucccd9e706a19cc8586335b155a80c266_43860_192x192_resize_q75_h2_box_2.webp sizes=192x192 type=image/webp><link rel=mask-icon href=/myblog/safari-pinned-tab.svg color=#6f42c1><meta name=keywords content="Hugo,Bootstrap,Blog Theme"><meta name=description content="简介 Resilience4j一个轻量级（只依赖Vavr第三方库）的，易于使用的容错框架，灵感来源于Netflix Hystrix，依托于java8的函数式编程。
Resilience4j提供了断路器、限速、重试、Bulkhead等功能。你可以任意选择和搭配这些功能。
Bulkhead(隔板模式)是一种容错的应用程序设计。 在隔板架构中，应用程序的元素被隔离到池中，因此，如果其中一个失败，则其他元素将继续运行。 它是根据船体的分段隔板（凸头）来命名的。 如果船体受损，则只有损坏的部分会充满水，从而防止船下沉。
以下示例显示了如何使用CircuitBreaker和Retry装饰lambda表达式，以便在发生异常时最多重试3次。
// 创建默认的断路器 CircuitBreaker circuitBreaker = CircuitBreaker.ofDefaults(&#34;backendService&#34;); // 创建默认的重试器，重拾3次，间隔为500ms Retry retry = Retry.ofDefaults(&#34;backendService&#34;); // 创建默认的隔离器 Bulkhead bulkhead = Bulkhead.ofDefaults(&#34;backendService&#34;); //具体的业务调用 Supplier<String> supplier = () -> backendService.doSomething(param1, param2) // 使用装扮器装扮函数 Supplier<String> decoratedSupplier = Decorators.ofSupplier(supplier) .withCircuitBreaker(circuitBreaker) .withBulkhead(bulkhead) .withRetry(retry) .decorate(); // 执行函数，并设置后退函数 String result = Try.ofSupplier(decoratedSupplier) .recover(throwable -> &#34;Hello from Recovery&#34;).get(); // 不使用装扮器，直接使用断路器调用函数 String result = circuitBreaker .executeSupplier(backendService::doSomething); // 使用ThreadPoolBulkhead在另外的线程中异步运行 ThreadPoolBulkhead threadPoolBulkhead = ThreadPoolBulkhead.ofDefaults(&#34;backendService&#34;); // 设定超时机制，超时需要Scheduler来调度 ScheduledExecutorService scheduledExecutorService = Executors."><meta name=twitter:card content="summary"><meta name=twitter:title content="Resilience4j"><meta name=twitter:description content="简介 Resilience4j一个轻量级（只依赖Vavr第三方库）的，易于使用的容错框架，灵感来源于Netflix Hystrix，依托于java8的函数式编程。
Resilience4j提供了断路器、限速、重试、Bulkhead等功能。你可以任意选择和搭配这些功能。
Bulkhead(隔板模式)是一种容错的应用程序设计。 在隔板架构中，应用程序的元素被隔离到池中，因此，如果其中一个失败，则其他元素将继续运行。 它是根据船体的分段隔板（凸头）来命名的。 如果船体受损，则只有损坏的部分会充满水，从而防止船下沉。
以下示例显示了如何使用CircuitBreaker和Retry装饰lambda表达式，以便在发生异常时最多重试3次。
// 创建默认的断路器 CircuitBreaker circuitBreaker = CircuitBreaker.ofDefaults(&#34;backendService&#34;); // 创建默认的重试器，重拾3次，间隔为500ms Retry retry = Retry.ofDefaults(&#34;backendService&#34;); // 创建默认的隔离器 Bulkhead bulkhead = Bulkhead.ofDefaults(&#34;backendService&#34;); //具体的业务调用 Supplier<String> supplier = () -> backendService.doSomething(param1, param2) // 使用装扮器装扮函数 Supplier<String> decoratedSupplier = Decorators.ofSupplier(supplier) .withCircuitBreaker(circuitBreaker) .withBulkhead(bulkhead) .withRetry(retry) .decorate(); // 执行函数，并设置后退函数 String result = Try.ofSupplier(decoratedSupplier) .recover(throwable -> &#34;Hello from Recovery&#34;).get(); // 不使用装扮器，直接使用断路器调用函数 String result = circuitBreaker .executeSupplier(backendService::doSomething); // 使用ThreadPoolBulkhead在另外的线程中异步运行 ThreadPoolBulkhead threadPoolBulkhead = ThreadPoolBulkhead.ofDefaults(&#34;backendService&#34;); // 设定超时机制，超时需要Scheduler来调度 ScheduledExecutorService scheduledExecutorService = Executors."><meta property="og:title" content="Resilience4j"><meta property="og:description" content="简介 Resilience4j一个轻量级（只依赖Vavr第三方库）的，易于使用的容错框架，灵感来源于Netflix Hystrix，依托于java8的函数式编程。
Resilience4j提供了断路器、限速、重试、Bulkhead等功能。你可以任意选择和搭配这些功能。
Bulkhead(隔板模式)是一种容错的应用程序设计。 在隔板架构中，应用程序的元素被隔离到池中，因此，如果其中一个失败，则其他元素将继续运行。 它是根据船体的分段隔板（凸头）来命名的。 如果船体受损，则只有损坏的部分会充满水，从而防止船下沉。
以下示例显示了如何使用CircuitBreaker和Retry装饰lambda表达式，以便在发生异常时最多重试3次。
// 创建默认的断路器 CircuitBreaker circuitBreaker = CircuitBreaker.ofDefaults(&#34;backendService&#34;); // 创建默认的重试器，重拾3次，间隔为500ms Retry retry = Retry.ofDefaults(&#34;backendService&#34;); // 创建默认的隔离器 Bulkhead bulkhead = Bulkhead.ofDefaults(&#34;backendService&#34;); //具体的业务调用 Supplier<String> supplier = () -> backendService.doSomething(param1, param2) // 使用装扮器装扮函数 Supplier<String> decoratedSupplier = Decorators.ofSupplier(supplier) .withCircuitBreaker(circuitBreaker) .withBulkhead(bulkhead) .withRetry(retry) .decorate(); // 执行函数，并设置后退函数 String result = Try.ofSupplier(decoratedSupplier) .recover(throwable -> &#34;Hello from Recovery&#34;).get(); // 不使用装扮器，直接使用断路器调用函数 String result = circuitBreaker .executeSupplier(backendService::doSomething); // 使用ThreadPoolBulkhead在另外的线程中异步运行 ThreadPoolBulkhead threadPoolBulkhead = ThreadPoolBulkhead.ofDefaults(&#34;backendService&#34;); // 设定超时机制，超时需要Scheduler来调度 ScheduledExecutorService scheduledExecutorService = Executors."><meta property="og:type" content="article"><meta property="og:url" content="https://banrenshan.github.io/myblog/blog/2022/12/resilience4j/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-12-02T12:54:32+00:00"><meta property="article:modified_time" content="2023-10-07T19:19:27+08:00"><meta itemprop=name content="Resilience4j"><meta itemprop=description content="简介 Resilience4j一个轻量级（只依赖Vavr第三方库）的，易于使用的容错框架，灵感来源于Netflix Hystrix，依托于java8的函数式编程。
Resilience4j提供了断路器、限速、重试、Bulkhead等功能。你可以任意选择和搭配这些功能。
Bulkhead(隔板模式)是一种容错的应用程序设计。 在隔板架构中，应用程序的元素被隔离到池中，因此，如果其中一个失败，则其他元素将继续运行。 它是根据船体的分段隔板（凸头）来命名的。 如果船体受损，则只有损坏的部分会充满水，从而防止船下沉。
以下示例显示了如何使用CircuitBreaker和Retry装饰lambda表达式，以便在发生异常时最多重试3次。
// 创建默认的断路器 CircuitBreaker circuitBreaker = CircuitBreaker.ofDefaults(&#34;backendService&#34;); // 创建默认的重试器，重拾3次，间隔为500ms Retry retry = Retry.ofDefaults(&#34;backendService&#34;); // 创建默认的隔离器 Bulkhead bulkhead = Bulkhead.ofDefaults(&#34;backendService&#34;); //具体的业务调用 Supplier<String> supplier = () -> backendService.doSomething(param1, param2) // 使用装扮器装扮函数 Supplier<String> decoratedSupplier = Decorators.ofSupplier(supplier) .withCircuitBreaker(circuitBreaker) .withBulkhead(bulkhead) .withRetry(retry) .decorate(); // 执行函数，并设置后退函数 String result = Try.ofSupplier(decoratedSupplier) .recover(throwable -> &#34;Hello from Recovery&#34;).get(); // 不使用装扮器，直接使用断路器调用函数 String result = circuitBreaker .executeSupplier(backendService::doSomething); // 使用ThreadPoolBulkhead在另外的线程中异步运行 ThreadPoolBulkhead threadPoolBulkhead = ThreadPoolBulkhead.ofDefaults(&#34;backendService&#34;); // 设定超时机制，超时需要Scheduler来调度 ScheduledExecutorService scheduledExecutorService = Executors."><meta itemprop=datePublished content="2022-12-02T12:54:32+00:00"><meta itemprop=dateModified content="2023-10-07T19:19:27+08:00"><meta itemprop=wordCount content="2629"><meta itemprop=keywords content="java,"><meta property="og:image" content="https://banrenshan.github.io/myblog/images/logo.png"><meta name=twitter:image content="https://banrenshan.github.io/myblog/images/logo.png"><meta property="og:image:alt" content="Resilience4j"><meta name=twitter:image:alt content="Resilience4j"><link rel=manifest href=/myblog/manifest.json><link data-precache rel=stylesheet href="/myblog/assets/main/bundle.min.906e48a4015f207e7ad2852421d4b8e6fda8fb5c6d1fff31855591474e60da12.css" integrity="sha256-kG5IpAFfIH560oUkIdS45v2o+1xtH/8xhVWRR05g2hI=" crossorigin=anonymous><link data-precache rel=stylesheet href=/myblog/assets/viewer/bundle.min.eb914844636cd41f221f109e99c887bbc3b6b5ffb2af7c664b284cea2d1b54b7.css integrity="sha256-65FIRGNs1B8iHxCemciHu8O2tf+yr3xmSyhM6i0bVLc=" crossorigin=anonymous></head><body><header class="mb-4 sticky-top"><nav class="top-app-bar shadow navbar navbar-expand-xxl"><div class=container><a class="navbar-brand d-flex align-items-center flex-grow-1 flex-xxl-grow-0 justify-content-xxl-start ms-2 ms-xxl-0 mx-auto me-xxl-2" href=https://banrenshan.github.io/myblog/><picture><img class=logo alt=Logo src=https://banrenshan.github.io/myblog/images/logo.webp loading=lazy width=400 height=400></picture></a><div class="offcanvas-xxl offcanvas-end flex-grow-1" data-bs-scroll=true tabindex=-1 id=navbarMenus aria-labelledby=navbarMenusLabel><div class="offcanvas-header px-4 pb-0"><div class="offcanvas-title h5" id=navbarMenusLabel></div><button type=button class="btn-close btn-close-white" data-bs-dismiss=offcanvas data-bs-target=#navbarMenus aria-label=Close></button></div><div class="offcanvas-body p-4 pt-0 p-xxl-0"><hr class=d-xxl-none><ul class="navbar-nav flex-row flex-wrap align-items-center me-auto"><li class="nav-item col-6 col-xxl-auto"><a class="nav-link py-2 px-0 px-xxl-2" href=https://banrenshan.github.io/myblog/docs/><span class="menu-icon me-1"><i class="fas fa-fw fa-book"></i></span>文档</a></li><li class="nav-item col-6 col-xxl-auto"><a class="nav-link py-2 px-0 px-xxl-2" href=https://banrenshan.github.io/myblog/series/><span class="menu-icon me-1"><i class="fas fa-fw fa-columns"></i></span>专栏</a></li><li class="nav-item col-6 col-xxl-auto"><a class="nav-link py-2 px-0 px-xxl-2" href=https://banrenshan.github.io/myblog/categories/><span class="menu-icon me-1"><i class="fas fa-fw fa-folder"></i></span>分类</a></li><li class="nav-item col-6 col-xxl-auto"><a class="nav-link py-2 px-0 px-xxl-2" href=https://banrenshan.github.io/myblog/archives/><span class="menu-icon me-1"><i class="fas fa-fw fa-file-archive"></i></span>归档</a></li><li class="nav-item col-6 col-xxl-auto"><a class="nav-link py-2 px-0 px-xxl-2" href=https://banrenshan.github.io/myblog/tags/><span class="menu-icon me-1"><i class="fas fa-fw fa-tags"></i></span>标签</a></li></ul><hr class=d-xxl-none><form class="search-bar ms-auto my-auto" action=/myblog/search/ novalidate><div class="input-group input-group-sm align-items-center"><span class="btn btn-search disabled position-absolute left-0 border-0 px-1"><i class="fas fa-fw fa-search fa-lg"></i></span>
<input class="my-1 form-control border-white rounded-5 search-input bg-body" name=q type=search placeholder=搜索 aria-label=Search required>
<span class="search-shortcut position-absolute end-0 top-0 me-2"><kbd class="bg-primary rounded shadow">/</kbd></span></div></form><hr class=d-xxl-none><ul class="navbar-nav flex-row flex-wrap align-items-center ms-md-auto"><li class="nav-item dropdown col-6 col-xxl-auto"><a class="nav-link px-0 py-2 px-xxl-1" href=# id=fontSizeDropdown role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-fw fa-font"></i>
<span class=d-xxl-none>字体大小</span></a><ul class="font-size-dropdown-menu dropdown-menu dropdown-menu-end" aria-labelledby=fontSizeDropdown><li><button class="font-size-item dropdown-item" data-size=xs>
特小号</button></li><li><button class="font-size-item dropdown-item" data-size=sm>
小号</button></li><li><button class="font-size-item dropdown-item active" data-size=md>
中等</button></li><li><button class="font-size-item dropdown-item" data-size=lg>
大号</button></li><li><button class="font-size-item dropdown-item" data-size=xl>
特大号</button></li></ul></li><li class="nav-item dropdown col-6 col-xxl-auto"><a class="nav-link px-0 py-2 px-xxl-1" href=# id=paletteDropdown role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-fw fa-palette"></i>
<span class=d-xxl-none>配色</span></a><ul class="palette-dropdown-menu dropdown-menu dropdown-menu-end px-2 row g-2" aria-labelledby=paletteDropdown><li class="col-4 my-1"><a role=button id=palette-blue aria-label=蓝色 class="btn btn-sm w-100 palette text-bg-blue" data-palette=blue></a></li><li class="col-4 my-1"><a role=button id=palette-blue-gray aria-label=蓝灰色 class="btn btn-sm w-100 palette text-bg-blue-gray" data-palette=blue-gray></a></li><li class="col-4 my-1"><a role=button id=palette-brown aria-label=棕色 class="btn btn-sm w-100 palette text-bg-brown" data-palette=brown></a></li><li class="col-4 my-1"><a role=button id=palette-cyan aria-label=青色 class="btn btn-sm w-100 palette text-bg-cyan" data-palette=cyan></a></li><li class="col-4 my-1"><a role=button id=palette-green aria-label=绿色 class="btn btn-sm w-100 palette text-bg-green" data-palette=green></a></li><li class="col-4 my-1"><a role=button id=palette-indigo aria-label=靛青色 class="btn btn-sm w-100 palette text-bg-indigo" data-palette=indigo></a></li><li class="col-4 my-1"><a role=button id=palette-orange aria-label=橙色 class="btn btn-sm w-100 palette text-bg-orange" data-palette=orange></a></li><li class="col-4 my-1"><a role=button id=palette-pink aria-label=粉色 class="btn btn-sm w-100 palette text-bg-pink" data-palette=pink></a></li><li class="col-4 my-1"><a role=button id=palette-purple aria-label=紫色 class="btn btn-sm w-100 palette text-bg-purple" data-palette=purple></a></li><li class="col-4 my-1"><a role=button id=palette-red aria-label=红色 class="btn btn-sm w-100 palette text-bg-red" data-palette=red></a></li><li class="col-4 my-1"><a role=button id=palette-teal aria-label=蓝绿色 class="btn btn-sm w-100 palette text-bg-teal" data-palette=teal></a></li><li class="col-4 my-1"><a role=button id=palette-yellow aria-label=黄色 class="btn btn-sm w-100 palette text-bg-yellow" data-palette=yellow></a></li></ul></li><li class="nav-item dropdown col-6 col-xxl-auto"><a class="nav-link px-0 py-2 px-xxl-1" href=# id=modeDropdown role=button data-bs-toggle=dropdown aria-expanded=false><i class="mode-icon fas fa-fw fa-adjust" id=modeIcon></i>
<span class=d-xxl-none>模式</span></a><ul class="mode-dropdown-menu dropdown-menu dropdown-menu-end" aria-labelledby=modeDropdown><li class=mode-item data-color-mode=light data-icon=sun><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-sun"></i> 浅色</button></li><li class=mode-item data-color-mode=dark data-icon=moon><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-moon"></i> 深色</button></li><li class="mode-item active" data-color-mode=auto data-icon=adjust><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-adjust"></i> 自动</button></li></ul></li></ul></div></div><div class=d-flex><button class="navbar-toggler order-5 border-0" type=button data-bs-toggle=offcanvas data-bs-target=#navbarMenus aria-controls=navbarMenus aria-expanded=false aria-label="Toggle navigation">
<i class="fas fa-ellipsis-h"></i></button></div></div></nav></header><main class=container><div class="row content"><noscript><div class="alert alert-danger" role=alert>你的浏览器不支持 JavaScript。</div></noscript><div class=col-xxl-8><div class=container><nav class="row card component" aria-label=breadcrumb><div class="card-body pb-0"><ol class="hbs-breadcrumb breadcrumb flex-nowrap"><li class="breadcrumb-item text-surface"><a href=/myblog/>主页</a></li><li class="breadcrumb-item text-surface"><a href=/myblog/blog/>Blogs</a></li><li class="breadcrumb-item active">Resilience4j</li></ol></div></nav><div class="post-panel-wrapper position-relative d-flex justify-content-center"><div class="d-flex flex-row justify-content-center rounded-5 border post-panel position-fixed px-3 py-1 surface shadow-1"><a class="action action-toc d-none d-xxl-block" href=#postTOC role=button title="Table of contents"><i class="fas fa-fw fa-list-alt"></i></a>
<a class="action action-toc d-block d-xxl-none" href=#post-toc-container role=button title="Table of contents"><i class="fas fa-fw fa-list-alt"></i></a>
<a class="action action-post-comments" href=#post-comments role=button aria-label=Comments title=Comments><i class="fas fa-fw fa-comments"></i></a>
<a id=sidebarToggler class="action action-sidebar-toggler d-none d-xxl-block" role=button title="Sidebar toggler"><i class="fas fa-fw fa-expand-alt" data-fa-transform=rotate-45></i></a></div></div><article class="row card component mb-4 post"><div class=card-header><h1 class="card-title post-title my-2">Resilience4j</h1></div><div class=card-body><div class="post-meta mb-3"><span class="post-date me-1 mb-1" title="创建于 2022-12-02 12:54:32 +0000 UTC，更新于 2023-10-07 11:19:27 +0000 UTC。">2022年12月2日</span><span class="post-reading-time me-1 mb-1">13 分钟阅读</span><a href=/myblog/categories/%E6%8A%80%E6%9C%AF/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-category">
<i class="fas fa-fw fa-folder me-1"></i>技术</a><a href=/myblog/tags/java/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-tag">Java</a></div><div class="mt-2 mb-3 d-block d-xxl-none"><h2 class="text-surface mb-3">目录</h2><div id=post-toc-container></div><hr class=text-secondary></div><div class="post-content mb-3" data-bs-spy=scroll data-bs-target=#TableOfContents tabindex=0><div id=post-content-body><h1 id=简介 data-numberify>简介<a class="anchor ms-1" href=#简介></a></h1><p>Resilience4j一个轻量级（只依赖Vavr第三方库）的，易于使用的容错框架，灵感来源于Netflix Hystrix，依托于java8的函数式编程。</p><p>Resilience4j提供了断路器、限速、重试、Bulkhead等功能。你可以任意选择和搭配这些功能。</p><p>Bulkhead(隔板模式)是一种容错的应用程序设计。 在隔板架构中，应用程序的元素被隔离到池中，因此，如果其中一个失败，则其他元素将继续运行。 它是根据船体的分段隔板（凸头）来命名的。 如果船体受损，则只有损坏的部分会充满水，从而防止船下沉。</p><p>以下示例显示了如何使用CircuitBreaker和Retry装饰lambda表达式，以便在发生异常时最多重试3次。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 创建默认的断路器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>CircuitBreaker</span> <span class=n>circuitBreaker</span> <span class=o>=</span> <span class=n>CircuitBreaker</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>(</span><span class=s>&#34;backendService&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 创建默认的重试器，重拾3次，间隔为500ms
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Retry</span> <span class=n>retry</span> <span class=o>=</span> <span class=n>Retry</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>(</span><span class=s>&#34;backendService&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 创建默认的隔离器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Bulkhead</span> <span class=n>bulkhead</span> <span class=o>=</span> <span class=n>Bulkhead</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>(</span><span class=s>&#34;backendService&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>//具体的业务调用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Supplier</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>supplier</span> <span class=o>=</span> <span class=o>()</span> <span class=o>-&gt;</span> <span class=n>backendService</span><span class=o>.</span><span class=na>doSomething</span><span class=o>(</span><span class=n>param1</span><span class=o>,</span> <span class=n>param2</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 使用装扮器装扮函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Supplier</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>decoratedSupplier</span> <span class=o>=</span> <span class=n>Decorators</span><span class=o>.</span><span class=na>ofSupplier</span><span class=o>(</span><span class=n>supplier</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>withCircuitBreaker</span><span class=o>(</span><span class=n>circuitBreaker</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>withBulkhead</span><span class=o>(</span><span class=n>bulkhead</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>withRetry</span><span class=o>(</span><span class=n>retry</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>decorate</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 执行函数，并设置后退函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>String</span> <span class=n>result</span> <span class=o>=</span> <span class=n>Try</span><span class=o>.</span><span class=na>ofSupplier</span><span class=o>(</span><span class=n>decoratedSupplier</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>recover</span><span class=o>(</span><span class=n>throwable</span> <span class=o>-&gt;</span> <span class=s>&#34;Hello from Recovery&#34;</span><span class=o>).</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 不使用装扮器，直接使用断路器调用函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>String</span> <span class=n>result</span> <span class=o>=</span> <span class=n>circuitBreaker</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>executeSupplier</span><span class=o>(</span><span class=n>backendService</span><span class=o>::</span><span class=n>doSomething</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 使用ThreadPoolBulkhead在另外的线程中异步运行
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=n>ThreadPoolBulkhead</span> <span class=n>threadPoolBulkhead</span> <span class=o>=</span> <span class=n>ThreadPoolBulkhead</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>(</span><span class=s>&#34;backendService&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 设定超时机制，超时需要Scheduler来调度
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ScheduledExecutorService</span> <span class=n>scheduledExecutorService</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newScheduledThreadPool</span><span class=o>(</span><span class=mi>3</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>TimeLimiter</span> <span class=n>timeLimiter</span> <span class=o>=</span> <span class=n>TimeLimiter</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>ofSeconds</span><span class=o>(</span><span class=mi>1</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>future</span> <span class=o>=</span> <span class=n>Decorators</span><span class=o>.</span><span class=na>ofSupplier</span><span class=o>(</span><span class=n>supplier</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>withThreadPoolBulkhead</span><span class=o>(</span><span class=n>threadPoolBulkhead</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>withTimeLimiter</span><span class=o>(</span><span class=n>timeLimiter</span><span class=o>,</span> <span class=n>scheduledExecutorService</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>withCircuitBreaker</span><span class=o>(</span><span class=n>circuitBreaker</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>withFallback</span><span class=o>(</span><span class=n>asList</span><span class=o>(</span><span class=n>TimeoutException</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>                         <span class=n>CallNotPermittedException</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>                         <span class=n>BulkheadFullException</span><span class=o>.</span><span class=na>class</span><span class=o>),</span>  
</span></span><span class=line><span class=cl>                  <span class=n>throwable</span> <span class=o>-&gt;</span> <span class=s>&#34;Hello from Recovery&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>get</span><span class=o>().</span><span class=na>toCompletableFuture</span><span class=o>();</span>
</span></span></code></pre></div><p>您可以配置重试之间的等待间隔，还可以配置回退算法。</p><p>当所有重试均失败时，该示例使用Vavr的monad从异常中恢复并调用另一个lambda表达式作为后备。</p><h1 id=模块 data-numberify>模块<a class="anchor ms-1" href=#模块></a></h1><p>核心模块</p><ul><li>resilience4j-circuitbreaker: Circuit breaking</li><li>resilience4j-ratelimiter: Rate limiting</li><li>resilience4j-bulkhead: Bulkheading</li><li>resilience4j-retry: Automatic retrying (sync and async)</li><li>resilience4j-cache: Result caching</li><li>resilience4j-timelimiter: Timeout handling</li></ul><p>扩展模块</p><ul><li>resilience4j-retrofit: Retrofit adapter</li><li>resilience4j-feign: Feign adapter</li><li>resilience4j-consumer: Circular Buffer Event consumer</li><li>resilience4j-kotlin: Kotlin coroutines support</li></ul><p>框架模块</p><ul><li>resilience4j-spring-boot: Spring Boot Starter</li><li>resilience4j-spring-boot2: Spring Boot 2 Starter</li><li>resilience4j-ratpack: Ratpack Starter</li><li>resilience4j-vertx: Vertx Future decorator</li></ul><p>Reactive 模块</p><ul><li>resilience4j-rxjava2: Custom RxJava2 operators</li><li>resilience4j-reactor: Custom Spring Reactor operators</li></ul><p>Metrics modules</p><ul><li>resilience4j-micrometer: Micrometer Metrics exporter</li><li>resilience4j-metrics: Dropwizard Metrics exporter</li><li>resilience4j-prometheus: Prometheus Metrics exporter</li></ul><h1 id=circuitbreaker data-numberify>CircuitBreaker<a class="anchor ms-1" href=#circuitbreaker></a></h1><p>断路器又三个正常状态：CLOSE，OPEN和HALF_OPEN ,两个特殊状态 DISABLED和FORCED_OPEN.</p><p><picture><img class=img-fluid alt=img src loading=lazy></picture></p><p>断路器使用滑动窗口来存储和汇总调用结果，这个窗口可以基于计数或时间。基于计数的滑动窗口汇总了最近N个调用的结果。 基于时间的滑动窗口汇总了最近N秒的调用结果。</p><ul><li>基于计数的滑动窗口由N个测量值的圆形数组实现。如果计数窗口大小为10，则圆形阵列始终具有10个测量值。滑动窗口以增量方式更新汇总结果。 当记录新的call结果时，将更新总汇总。 收回最旧的度量后，将从总聚合中减去该度量，然后重置存储桶。 （逐项扣除）</li><li>基于时间的滑动窗口是由N个部分汇总结果（存储桶）的圆形数组实现的。如果时间窗口大小为10秒，则圆形数组将始终具有10个部分汇总结果（存储桶）。 每个存储段都会汇总在某个纪元秒内发生的所有调用的结果。 圆形数组的头存储区存储当前纪元的call结果。 其他部分聚合存储前几秒的call结果。滑动窗口不会单独存储call结果（元组），而是以增量方式更新部分聚合（存储桶）和总聚合。当记录新的call结果时，总聚合将增量更新。 当最旧的存储桶被收回时，该存储桶的部分总聚合将从总聚合中减去，然后重置该存储桶（逐项扣除）。 <code>部分聚合</code> 由3个整数组成，以计算失败的call数，慢速call数和总call数。 一个长存储所有call的总持续时间。</li></ul><h2 id=故障率和慢速调用率阈值 data-numberify>故障率和慢速调用率阈值<a class="anchor ms-1" href=#故障率和慢速调用率阈值></a></h2><p>当故障率等于或大于配置的阈值时，CircuitBreaker的状态将从“CLOSE”更改为“OPEN”。 例如，当超过50％的call失败时。默认情况下，所有异常均视为失败。 您可以定义应视为失败的异常列表。 除非忽略所有其他异常，否则所有其他异常均被视为成功。 也可以忽略异常，以使它们既不算作失败也不算成功。</p><p>当慢速呼叫的百分比等于或大于配置的阈值时，CircuitBreaker也会从CLOSED变为OPEN。 例如，当超过50％的call时间超过5秒。 这有助于减轻被调用系统的负担。</p><p>如果记录的call数量达到指定的要求，才会计算故障率和慢速呼叫率。 例如，如果所需call的最小数量为10，则必须至少记录10个call，然后才能计算出故障率。 如果仅评估了9个call，则即使所有9个call均失败，CircuitBreaker也不会跳闸。</p><p>当断路器打开时，返回CallNotPermittedException 异常。 经过一段等待时间后，CircuitBreaker状态从OPEN变为HALF_OPEN，并允许可配置数量的call以查看后端是否可用， 除非所有允许的call都已完成，否则将通过CallNotPermittedException拒绝进一步的call。</p><p>断路器支持另外两个特殊状态，即DISABLED（始终允许访问）和FORCED_OPEN（始终拒绝访问）。 在这两种状态下，不会生成任何断路器事件（状态转换除外），也不会记录任何度量。 退出这些状态的唯一方法是触发状态转换或重置断路器。</p><p>CircuitBreaker是线程安全的，如下所示：</p><ul><li>CircuitBreaker的状态存储在AtomicReference中</li><li>CircuitBreaker使用原子操作来更新状态。</li><li>从“滑动窗口”记录call和读取快照是同步操作</li></ul><p>如果有20个并发线程请求执行函数的许可，并且CircuitBreaker的状态关闭，则允许所有线程调用该功能。 即使滑动窗口的大小为15。滑动窗口也不意味着仅允许15个调用并发运行。 如果要限制并发线程的数量，请使用Bulkhead。 您可以组合使用Bulkhead和CircuitBreaker。</p><p><strong>单个线程的示意图</strong></p><p><picture><img class=img-fluid alt=img src loading=lazy></picture></p><p><strong>三个线程的示意图</strong></p><p><picture><img class=img-fluid alt=img src loading=lazy></picture></p><h2 id=如何使用 data-numberify>如何使用<a class="anchor ms-1" href=#如何使用></a></h2><p>基于ConcurrentHashMap的CircuitBreakerRegistry，可提供线程安全性和原子性保证。 您可以使用CircuitBreakerRegistry来管理（创建和检索）CircuitBreaker实例。 您可以为所有CircuitBreaker实例创建一个具有全局默认CircuitBreakerConfig的CircuitBreakerRegistry，如下所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>CircuitBreakerRegistry</span> <span class=n>circuitBreakerRegistry</span> <span class=o>=</span> <span class=n>CircuitBreakerRegistry</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>();</span>
</span></span></code></pre></div><h3 id=断路器配置 data-numberify>断路器配置<a class="anchor ms-1" href=#断路器配置></a></h3><p>您可以提供自定义的全局CircuitBreakerConfig。 为了创建定制的全局CircuitBreakerConfig，可以使用CircuitBreakerConfig构建器。 您可以使用构建器来配置以下属性。</p><table><thead><tr><th>配置的属性</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>failureRateThreshold</td><td>50</td><td>以百分比配置故障率阈值。当故障率等于或大于阈值时，CircuitBreaker转换为打开状态。</td></tr><tr><td>slowCallRateThreshold</td><td>100</td><td>当call持续时间slowCallDurationThreshold时，CircuitBreaker会将call视为慢速call 当慢速call的百分比等于或大于阈值时，CircuitBreaker转换为打开状态</td></tr><tr><td>slowCallDurationThreshold</td><td>60000 [ms]</td><td>当call的调用时间超过改值时，认为时慢速的</td></tr><tr><td>permittedNumberOfCalls InHalfOpenState</td><td>10</td><td>配置CircuitBreaker半打开时允许的call数。</td></tr><tr><td>maxWaitDurationInHalfOpenState</td><td>0</td><td>该时间用于控制CircuitBreaker在切换到打开之前可以保持在Half Open状态的最长时间。值0表示断路器将在HalfOpen状态下无限期等待，直到所有允许的call完成。</td></tr><tr><td>slidingWindowType</td><td>COUNT_BASED</td><td>配置滑动窗口的类型，如果是 COUNT_BASED, 最后的 slidingWindowSize个call被记录和汇总；如果是 TIME_BASED, 最后slidingWindowSize秒数内的请求被记录和汇总</td></tr><tr><td>slidingWindowSize</td><td>100</td><td>配置滑动窗口的大小，该窗口用于在CircuitBreaker关闭时记录call结果。</td></tr><tr><td>minimumNumberOfCalls</td><td>100</td><td>配置CircuitBreaker可以计算错误率或慢速呼叫率之前所需的最小呼叫数（每个滑动窗口时段）。例如，如果minimumNumberOfCalls为10，则必须至少记录10个呼叫，然后才能计算失败率。如果仅记录了9个呼叫，则即使所有9个呼叫均失败，CircuitBreaker也不会转换为打开。</td></tr><tr><td>waitDurationInOpenState</td><td>60000 [ms]</td><td>从断开到半开之前CircuitBreaker应该等待的时间。</td></tr><tr><td>automaticTransition FromOpenToHalfOpenEnabled</td><td>false</td><td>如果设置为true，则意味着CircuitBreaker将自动从打开状态转换为半打开状态，不需要调用即可触发该转换。 一旦waitDurationInOpenState通过，就会创建一个线程来监视CircuitBreakers的所有实例，以将其转换为HALF_OPEN。 而如果将其设置为false，则即使在传递了waitDurationInOpenState之后，也只有在进行调用时才发生向HALF_OPEN的转换。 这里的优点是没有线程监视所有CircuitBreakers的状态。</td></tr><tr><td>recordExceptions</td><td>empty</td><td>记录为故障的异常列表。 除非通过ignoreExceptions表明确忽略，否则任何与列表之一匹配或继承的异常都将视为失败。 如果指定ignoreExceptions例外列表，则所有其他例外都将视为成功，除非它们被显式忽略</td></tr><tr><td>ignoreExceptions</td><td>empty</td><td>忽略的异常列表，既不算作失败也不算成功。 从列表之一匹配或继承的任何异常都不会被视为失败或成功，即使该异常是recordExceptions其中的一部分</td></tr><tr><td>recordException</td><td>throwable -> true 所有异常</td><td>一个自定义谓词，用于评估是否应将异常记录为失败。 如果异常应计为失败，则谓词必须返回true。 除非成功将ignoreExceptions异常显式忽略，否则应该算是成功</td></tr><tr><td>ignoreException</td><td>throwable -> false 没有yi</td><td>一个自定义谓词，用于评估是否应忽略异常，并且该异常既不算作失败也不算成功。 如果应忽略异常，则谓词必须返回true。 如果异常应计为失败，则谓词必须返回false。</td></tr></tbody></table><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 自定义CircuitBreaker的配置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>CircuitBreakerConfig</span> <span class=n>circuitBreakerConfig</span> <span class=o>=</span> <span class=n>CircuitBreakerConfig</span><span class=o>.</span><span class=na>custom</span><span class=o>()</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>failureRateThreshold</span><span class=o>(</span><span class=mi>50</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>slowCallRateThreshold</span><span class=o>(</span><span class=mi>50</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>waitDurationInOpenState</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>ofMillis</span><span class=o>(</span><span class=mi>1000</span><span class=o>))</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>slowCallDurationThreshold</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>ofSeconds</span><span class=o>(</span><span class=mi>2</span><span class=o>))</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>permittedNumberOfCallsInHalfOpenState</span><span class=o>(</span><span class=mi>3</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>minimumNumberOfCalls</span><span class=o>(</span><span class=mi>10</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>slidingWindowType</span><span class=o>(</span><span class=n>SlidingWindowType</span><span class=o>.</span><span class=na>TIME_BASED</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>slidingWindowSize</span><span class=o>(</span><span class=mi>5</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>recordException</span><span class=o>(</span><span class=n>e</span> <span class=o>-&gt;</span> <span class=n>INTERNAL_SERVER_ERROR</span>
</span></span><span class=line><span class=cl>                 <span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>getResponse</span><span class=o>().</span><span class=na>getStatus</span><span class=o>()))</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>recordExceptions</span><span class=o>(</span><span class=n>IOException</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>TimeoutException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>ignoreExceptions</span><span class=o>(</span><span class=n>BusinessException</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>OtherBusinessException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 使用自定义配置创建CircuitBreakerRegistry
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>CircuitBreakerRegistry</span> <span class=n>circuitBreakerRegistry</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>  <span class=n>CircuitBreakerRegistry</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>circuitBreakerConfig</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 创建默认的断路器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>CircuitBreaker</span> <span class=n>circuitBreakerWithDefaultConfig</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>  <span class=n>circuitBreakerRegistry</span><span class=o>.</span><span class=na>circuitBreaker</span><span class=o>(</span><span class=s>&#34;name1&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 自定义断路器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>CircuitBreaker</span> <span class=n>circuitBreakerWithCustomConfig</span> <span class=o>=</span> <span class=n>circuitBreakerRegistry</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>circuitBreaker</span><span class=o>(</span><span class=s>&#34;name2&#34;</span><span class=o>,</span> <span class=n>circuitBreakerConfig</span><span class=o>);</span>
</span></span></code></pre></div><p>创建由多个实例共享的配置:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>CircuitBreakerConfig</span> <span class=n>circuitBreakerConfig</span> <span class=o>=</span> <span class=n>CircuitBreakerConfig</span><span class=o>.</span><span class=na>custom</span><span class=o>()</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>failureRateThreshold</span><span class=o>(</span><span class=mi>70</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>circuitBreakerRegistry</span><span class=o>.</span><span class=na>addConfiguration</span><span class=o>(</span><span class=s>&#34;someSharedConfig&#34;</span><span class=o>,</span> <span class=n>config</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>CircuitBreaker</span> <span class=n>circuitBreaker</span> <span class=o>=</span> <span class=n>circuitBreakerRegistry</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>circuitBreaker</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>,</span> <span class=s>&#34;someSharedConfig&#34;</span><span class=o>);</span>
</span></span></code></pre></div><p>覆盖默认配置:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>CircuitBreakerConfig</span> <span class=n>defaultConfig</span> <span class=o>=</span> <span class=n>circuitBreakerRegistry</span>
</span></span><span class=line><span class=cl>   <span class=o>.</span><span class=na>getDefaultConfig</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>CircuitBreakerConfig</span> <span class=n>overwrittenConfig</span> <span class=o>=</span> <span class=n>CircuitBreakerConfig</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>from</span><span class=o>(</span><span class=n>defaultConfig</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>waitDurationInOpenState</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>ofSeconds</span><span class=o>(</span><span class=mi>20</span><span class=o>))</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span></code></pre></div><p>如果您不想使用CircuitBreakerRegistry管理CircuitBreaker实例，也可以直接创建实例:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Create a custom configuration for a CircuitBreaker
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>CircuitBreakerConfig</span> <span class=n>circuitBreakerConfig</span> <span class=o>=</span> <span class=n>CircuitBreakerConfig</span><span class=o>.</span><span class=na>custom</span><span class=o>()</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>recordExceptions</span><span class=o>(</span><span class=n>IOException</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>TimeoutException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>ignoreExceptions</span><span class=o>(</span><span class=n>BusinessException</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>OtherBusinessException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>CircuitBreaker</span> <span class=n>customCircuitBreaker</span> <span class=o>=</span> <span class=n>CircuitBreaker</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;testName&#34;</span><span class=o>,</span> <span class=n>circuitBreakerConfig</span><span class=o>);</span>
</span></span></code></pre></div><p>您还可以使用其生成器方法创建CircuitBreakerRegistry：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Map</span> <span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>circuitBreakerTags</span> <span class=o>=</span> <span class=n>Map</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;key1&#34;</span><span class=o>,</span> <span class=s>&#34;value1&#34;</span><span class=o>,</span> <span class=s>&#34;key2&#34;</span><span class=o>,</span> <span class=s>&#34;value2&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>CircuitBreakerRegistry</span> <span class=n>circuitBreakerRegistry</span> <span class=o>=</span> <span class=n>CircuitBreakerRegistry</span><span class=o>.</span><span class=na>custom</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>withCircuitBreakerConfig</span><span class=o>(</span><span class=n>CircuitBreakerConfig</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>())</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>addRegistryEventConsumer</span><span class=o>(</span><span class=k>new</span> <span class=n>RegistryEventConsumer</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onEntryAddedEvent</span><span class=o>(</span><span class=n>EntryAddedEvent</span> <span class=n>entryAddedEvent</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// implementation
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onEntryRemovedEvent</span><span class=o>(</span><span class=n>EntryRemovedEvent</span> <span class=n>entryRemoveEvent</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// implementation
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onEntryReplacedEvent</span><span class=o>(</span><span class=n>EntryReplacedEvent</span> <span class=n>entryReplacedEvent</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// implementation
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>})</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>withTags</span><span class=o>(</span><span class=n>circuitBreakerTags</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>CircuitBreaker</span> <span class=n>circuitBreaker</span> <span class=o>=</span> <span class=n>circuitBreakerRegistry</span><span class=o>.</span><span class=na>circuitBreaker</span><span class=o>(</span><span class=s>&#34;testName&#34;</span><span class=o>);</span>
</span></span></code></pre></div><p>如果要插入自己的Registry实现，则可以提供Interface RegistryStore的自定义实现，并使用builder方法插入:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>CircuitBreakerRegistry</span> <span class=n>registry</span> <span class=o>=</span> <span class=n>CircuitBreakerRegistry</span><span class=o>.</span><span class=na>custom</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>withRegistryStore</span><span class=o>(</span><span class=k>new</span> <span class=n>YourRegistryStoreImplementation</span><span class=o>())</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>withCircuitBreakerConfig</span><span class=o>(</span><span class=n>CircuitBreakerConfig</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>())</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>build</span><span class=o>():</span>
</span></span></code></pre></div><h3 id=使用断路器装扮函数并调用 data-numberify>使用断路器装扮函数并调用<a class="anchor ms-1" href=#使用断路器装扮函数并调用></a></h3><p>您可以使用CircuitBreaker装饰任何Callable，Supplier，Runnable，Consumer，CheckedRunnable，CheckedSupplier，CheckedConsumer或CompletionStage。</p><p>您可以使用Vavr中的Try.of（&mldr;）或Try.run（&mldr;）来调用修饰的函数。 这允许使用map，flatMap，filter，recover或andThen链接其他功能。 仅当CircuitBreaker为CLOSED或HALF_OPEN时，才调用链接函数。</p><p>在下面的示例中，如果函数调用成功，则Try.of（&mldr;）返回Success Monad。 如果函数引发异常，则返回Failure Monad，并且不调用map。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Given
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>CircuitBreaker</span> <span class=n>circuitBreaker</span> <span class=o>=</span> <span class=n>CircuitBreaker</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>(</span><span class=s>&#34;testName&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// When I decorate my function
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>CheckedFunction0</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>decoratedSupplier</span> <span class=o>=</span> <span class=n>CircuitBreaker</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>decorateCheckedSupplier</span><span class=o>(</span><span class=n>circuitBreaker</span><span class=o>,</span> <span class=o>()</span> <span class=o>-&gt;</span> <span class=s>&#34;This can be any method which returns: &#39;Hello&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// and chain an other function with map
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Try</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>Try</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>decoratedSupplier</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>value</span> <span class=o>-&gt;</span> <span class=n>value</span> <span class=o>+</span> <span class=s>&#34; world&#39;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Then the Try Monad returns a Success&lt;String&gt;, if all functions ran successfully.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>assertThat</span><span class=o>(</span><span class=n>result</span><span class=o>.</span><span class=na>isSuccess</span><span class=o>()).</span><span class=na>isTrue</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>assertThat</span><span class=o>(</span><span class=n>result</span><span class=o>.</span><span class=na>get</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=s>&#34;This can be any method which returns: &#39;Hello world&#39;&#34;</span><span class=o>);</span>
</span></span></code></pre></div><p>您可以在CircuitBreakerRegistry上注册事件使用者，并在每次创建，替换或删除CircuitBreaker时采取措施。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>CircuitBreakerRegistry</span> <span class=n>circuitBreakerRegistry</span> <span class=o>=</span> <span class=n>CircuitBreakerRegistry</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>circuitBreakerRegistry</span><span class=o>.</span><span class=na>getEventPublisher</span><span class=o>()</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>onEntryAdded</span><span class=o>(</span><span class=n>entryAddedEvent</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>CircuitBreaker</span> <span class=n>addedCircuitBreaker</span> <span class=o>=</span> <span class=n>entryAddedEvent</span><span class=o>.</span><span class=na>getAddedEntry</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>LOG</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;CircuitBreaker {} added&#34;</span><span class=o>,</span> <span class=n>addedCircuitBreaker</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>})</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>onEntryRemoved</span><span class=o>(</span><span class=n>entryRemovedEvent</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>CircuitBreaker</span> <span class=n>removedCircuitBreaker</span> <span class=o>=</span> <span class=n>entryRemovedEvent</span><span class=o>.</span><span class=na>getRemovedEntry</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>LOG</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;CircuitBreaker {} removed&#34;</span><span class=o>,</span> <span class=n>removedCircuitBreaker</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>});</span>
</span></span></code></pre></div><p>CircuitBreakerEvent可以是状态转换，断路器重置，成功调用，记录的错误或忽略的错误。 所有事件都包含其他信息，例如事件创建时间和呼叫的处理持续时间。 如果要使用事件，则必须注册事件使用者。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>circuitBreaker</span><span class=o>.</span><span class=na>getEventPublisher</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>onSuccess</span><span class=o>(</span><span class=n>event</span> <span class=o>-&gt;</span> <span class=n>logger</span><span class=o>.</span><span class=na>info</span><span class=o>(...))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>onError</span><span class=o>(</span><span class=n>event</span> <span class=o>-&gt;</span> <span class=n>logger</span><span class=o>.</span><span class=na>info</span><span class=o>(...))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>onIgnoredError</span><span class=o>(</span><span class=n>event</span> <span class=o>-&gt;</span> <span class=n>logger</span><span class=o>.</span><span class=na>info</span><span class=o>(...))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>onReset</span><span class=o>(</span><span class=n>event</span> <span class=o>-&gt;</span> <span class=n>logger</span><span class=o>.</span><span class=na>info</span><span class=o>(...))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>onStateTransition</span><span class=o>(</span><span class=n>event</span> <span class=o>-&gt;</span> <span class=n>logger</span><span class=o>.</span><span class=na>info</span><span class=o>(...));</span>
</span></span><span class=line><span class=cl><span class=c1>// Or if you want to register a consumer listening
</span></span></span><span class=line><span class=cl><span class=c1>// to all events, you can do:
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>circuitBreaker</span><span class=o>.</span><span class=na>getEventPublisher</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>onEvent</span><span class=o>(</span><span class=n>event</span> <span class=o>-&gt;</span> <span class=n>logger</span><span class=o>.</span><span class=na>info</span><span class=o>(...));</span>
</span></span></code></pre></div><p>您可以使用CircularEventConsumer将事件存储在具有固定容量的循环缓冲区中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>CircularEventConsumer</span><span class=o>&lt;</span><span class=n>CircuitBreakerEvent</span><span class=o>&gt;</span> <span class=n>ringBuffer</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>  <span class=k>new</span> <span class=n>CircularEventConsumer</span><span class=o>&lt;&gt;(</span><span class=mi>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>circuitBreaker</span><span class=o>.</span><span class=na>getEventPublisher</span><span class=o>().</span><span class=na>onEvent</span><span class=o>(</span><span class=n>ringBuffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>List</span><span class=o>&lt;</span><span class=n>CircuitBreakerEvent</span><span class=o>&gt;</span> <span class=n>bufferedEvents</span> <span class=o>=</span> <span class=n>ringBuffer</span><span class=o>.</span><span class=na>getBufferedEvents</span><span class=o>()</span>
</span></span></code></pre></div><p>您可以使用RxJava或RxJava2适配器将EventPublisher转换为响应流。</p><p>您可以通过自定义实现覆盖内存RegistryStore。 例如，如果要使用在一定时间后删除未使用实例的缓存。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>CircuitBreakerRegistry</span> <span class=n>circuitBreakerRegistry</span> <span class=o>=</span> <span class=n>CircuitBreakerRegistry</span><span class=o>.</span><span class=na>custom</span><span class=o>()</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>withRegistryStore</span><span class=o>(</span><span class=k>new</span> <span class=n>CacheCircuitBreakerRegistryStore</span><span class=o>())</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span></code></pre></div><p>如果您想在CircuitBreaker将异常记录为失败之后从异常中恢复，则可以链接Try.recover（）方法。 仅当Try.of（）返回Failure Monad时，才调用恢复方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Given
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>CircuitBreaker</span> <span class=n>circuitBreaker</span> <span class=o>=</span> <span class=n>CircuitBreaker</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>(</span><span class=s>&#34;testName&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// When I decorate my function and invoke the decorated function
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>CheckedFunction0</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>checkedSupplier</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>  <span class=n>CircuitBreaker</span><span class=o>.</span><span class=na>decorateCheckedSupplier</span><span class=o>(</span><span class=n>circuitBreaker</span><span class=o>,</span> <span class=o>()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;BAM!&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span><span class=line><span class=cl><span class=n>Try</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>Try</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>checkedSupplier</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>recover</span><span class=o>(</span><span class=n>throwable</span> <span class=o>-&gt;</span> <span class=s>&#34;Hello Recovery&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Then the function should be a success, 
</span></span></span><span class=line><span class=cl><span class=c1>// because the exception could be recovered
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>assertThat</span><span class=o>(</span><span class=n>result</span><span class=o>.</span><span class=na>isSuccess</span><span class=o>()).</span><span class=na>isTrue</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=c1>// and the result must match the result of the recovery function.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>assertThat</span><span class=o>(</span><span class=n>result</span><span class=o>.</span><span class=na>get</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=s>&#34;Hello Recovery&#34;</span><span class=o>);</span>
</span></span></code></pre></div><p>如果要在CircuitBreaker将异常记录为失败之前从异常中恢复，可以执行以下操作：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Supplier</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>supplier</span> <span class=o>=</span> <span class=o>()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;BAM!&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Supplier</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>supplierWithRecovery</span> <span class=o>=</span> <span class=n>SupplierUtils</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>recover</span><span class=o>(</span><span class=n>supplier</span><span class=o>,</span> <span class=o>(</span><span class=n>exception</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=s>&#34;Hello Recovery&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>String</span> <span class=n>result</span> <span class=o>=</span> <span class=n>circuitBreaker</span><span class=o>.</span><span class=na>executeSupplier</span><span class=o>(</span><span class=n>supplierWithRecovery</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>assertThat</span><span class=o>(</span><span class=n>result</span><span class=o>).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=s>&#34;Hello Recovery&#34;</span><span class=o>);</span>
</span></span></code></pre></div><p>SupplierUtils和CallableUtils包含其他方法，例如andThen，可以采用这些方法来链接函数。 例如，检查HTTP响应的状态代码，以便可以引发异常。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Supplier</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>supplierWithResultAndExceptionHandler</span> <span class=o>=</span> <span class=n>SupplierUtils</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>andThen</span><span class=o>(</span><span class=n>supplier</span><span class=o>,</span> <span class=o>(</span><span class=n>result</span><span class=o>,</span> <span class=n>exception</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=s>&#34;Hello Recovery&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Supplier</span><span class=o>&lt;</span><span class=n>HttpResponse</span><span class=o>&gt;</span> <span class=n>supplier</span> <span class=o>=</span> <span class=o>()</span> <span class=o>-&gt;</span> <span class=n>httpClient</span><span class=o>.</span><span class=na>doRemoteCall</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>Supplier</span><span class=o>&lt;</span><span class=n>HttpResponse</span><span class=o>&gt;</span> <span class=n>supplierWithResultHandling</span> <span class=o>=</span> <span class=n>SupplierUtils</span><span class=o>.</span><span class=na>andThen</span><span class=o>(</span><span class=n>supplier</span><span class=o>,</span> <span class=n>result</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>result</span><span class=o>.</span><span class=na>getStatusCode</span><span class=o>()</span> <span class=o>==</span> <span class=mi>400</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>       <span class=k>throw</span> <span class=k>new</span> <span class=n>ClientException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>result</span><span class=o>.</span><span class=na>getStatusCode</span><span class=o>()</span> <span class=o>==</span> <span class=mi>500</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>       <span class=k>throw</span> <span class=k>new</span> <span class=n>ServerException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span><span class=line><span class=cl><span class=n>HttpResponse</span> <span class=n>httpResponse</span> <span class=o>=</span> <span class=n>circuitBreaker</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>executeSupplier</span><span class=o>(</span><span class=n>supplierWithResultHandling</span><span class=o>);</span>
</span></span></code></pre></div><p>断路器支持重置为原始状态，丢失所有指标并有效重置其滑动窗口。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>CircuitBreaker</span> <span class=n>circuitBreaker</span> <span class=o>=</span> <span class=n>CircuitBreaker</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>(</span><span class=s>&#34;testName&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>circuitBreaker</span><span class=o>.</span><span class=na>reset</span><span class=o>();</span>
</span></span></code></pre></div><p>手动转换为状态:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>CircuitBreaker</span> <span class=n>circuitBreaker</span> <span class=o>=</span> <span class=n>CircuitBreaker</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>(</span><span class=s>&#34;testName&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>circuitBreaker</span><span class=o>.</span><span class=na>transitionToDisabledState</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=c1>// circuitBreaker.onFailure(...) won&#39;t trigger a state change
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>circuitBreaker</span><span class=o>.</span><span class=na>transitionToClosedState</span><span class=o>();</span> <span class=c1>// will transition to CLOSED state and re-enable normal behaviour, keeping metrics
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>circuitBreaker</span><span class=o>.</span><span class=na>transitionToForcedOpenState</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=c1>// circuitBreaker.onSuccess(...) won&#39;t trigger a state change
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>circuitBreaker</span><span class=o>.</span><span class=na>reset</span><span class=o>();</span> <span class=c1>//  will transition to CLOSED state and re-enable normal behaviour, losing metrics
</span></span></span></code></pre></div><h1 id=bulkhead data-numberify>Bulkhead<a class="anchor ms-1" href=#bulkhead></a></h1><p>Resilience4j 提供了两种方式实现舱壁模式来隔离线程的执行：</p><ul><li>SemaphoreBulkhead使用信号量</li><li>FixedThreadPoolBulkhead 使用有界队列和固定大小的线程池</li></ul><p>SemaphoreBulkhead在各种线程和I/O模型上都能很好地工作。 它基于信号量，与Hystrix不同，它不提供“影子”线程池选项。 由客户端来确保正确的线程池大小（与配置一致）。</p><p>跟CircuitBreaker 模块一样，Bulkhead也提供了基于内存的BulkheadRegistry 和ThreadPoolBulkheadRegistry ，你可以使用他们来管理（创建和检索）Bulkhead 实例。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>BulkheadRegistry</span> <span class=n>bulkheadRegistry</span> <span class=o>=</span> <span class=n>BulkheadRegistry</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ThreadPoolBulkheadRegistry</span> <span class=n>threadPoolBulkheadRegistry</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>  <span class=n>ThreadPoolBulkheadRegistry</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>();</span>
</span></span></code></pre></div><p>你可以自定义全局配置，使用BulkheadConfig 构建，相关的可配置属性如下：</p><table><thead><tr><th>属性</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>maxConcurrentCalls</td><td>25</td><td>最大的并行执行数</td></tr><tr><td>maxWaitDuration</td><td>0</td><td>尝试进入饱和舱壁时，应阻塞线程的最长时间。</td></tr></tbody></table><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Create a custom configuration for a Bulkhead
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>BulkheadConfig</span> <span class=n>config</span> <span class=o>=</span> <span class=n>BulkheadConfig</span><span class=o>.</span><span class=na>custom</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>maxConcurrentCalls</span><span class=o>(</span><span class=mi>150</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>maxWaitDuration</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>ofMillis</span><span class=o>(</span><span class=mi>500</span><span class=o>))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create a BulkheadRegistry with a custom global configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>BulkheadRegistry</span> <span class=n>registry</span> <span class=o>=</span> <span class=n>BulkheadRegistry</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>config</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get or create a Bulkhead from the registry - 
</span></span></span><span class=line><span class=cl><span class=c1>// bulkhead will be backed by the default config
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Bulkhead</span> <span class=n>bulkheadWithDefaultConfig</span> <span class=o>=</span> <span class=n>registry</span><span class=o>.</span><span class=na>bulkhead</span><span class=o>(</span><span class=s>&#34;name1&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get or create a Bulkhead from the registry, 
</span></span></span><span class=line><span class=cl><span class=c1>// use a custom configuration when creating the bulkhead
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Bulkhead</span> <span class=n>bulkheadWithCustomConfig</span> <span class=o>=</span> <span class=n>registry</span><span class=o>.</span><span class=na>bulkhead</span><span class=o>(</span><span class=s>&#34;name2&#34;</span><span class=o>,</span> <span class=n>custom</span><span class=o>);</span>
</span></span></code></pre></div><p>ThreadPoolBulkhead配置的属性有所不同，使用ThreadPoolBulkheadConfig 构建配置项，属性列表如下：</p><table><thead><tr><th>配置属性</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>maxThreadPoolSize</td><td>Runtime.getRuntime() .availableProcessors()</td><td>线程池的最大大小</td></tr><tr><td>coreThreadPoolSize</td><td>Runtime.getRuntime() .availableProcessors() - 1</td><td>线程池的核心大小</td></tr><tr><td>queueCapacity</td><td>100</td><td>等待队列的容量</td></tr><tr><td>keepAliveDuration</td><td>20 [ms]</td><td>当线程数大于内核数时，这是多余的空闲线程最大空闲时间</td></tr></tbody></table><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ThreadPoolBulkheadConfig</span> <span class=n>config</span> <span class=o>=</span> <span class=n>ThreadPoolBulkheadConfig</span><span class=o>.</span><span class=na>custom</span><span class=o>()</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>maxThreadPoolSize</span><span class=o>(</span><span class=mi>10</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>coreThreadPoolSize</span><span class=o>(</span><span class=mi>2</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>queueCapacity</span><span class=o>(</span><span class=mi>20</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl><span class=c1>// Create a BulkheadRegistry with a custom global configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ThreadPoolBulkheadRegistry</span> <span class=n>registry</span> <span class=o>=</span> <span class=n>ThreadPoolBulkheadRegistry</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>config</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get or create a ThreadPoolBulkhead from the registry - 
</span></span></span><span class=line><span class=cl><span class=c1>// bulkhead will be backed by the default config
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ThreadPoolBulkhead</span> <span class=n>bulkheadWithDefaultConfig</span> <span class=o>=</span> <span class=n>registry</span><span class=o>.</span><span class=na>bulkhead</span><span class=o>(</span><span class=s>&#34;name1&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get or create a Bulkhead from the registry, 
</span></span></span><span class=line><span class=cl><span class=c1>// use a custom configuration when creating the bulkhead
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ThreadPoolBulkheadConfig</span> <span class=n>custom</span> <span class=o>=</span> <span class=n>BulkheadConfig</span><span class=o>.</span><span class=na>custom</span><span class=o>()</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>maxThreadPoolSize</span><span class=o>(</span><span class=mi>5</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ThreadPoolBulkhead</span> <span class=n>bulkheadWithCustomConfig</span> <span class=o>=</span> <span class=n>registry</span><span class=o>.</span><span class=na>bulkhead</span><span class=o>(</span><span class=s>&#34;name2&#34;</span><span class=o>,</span> <span class=n>custom</span><span class=o>);</span>
</span></span></code></pre></div><p>可以猜到，Bulkhead具有各种类似于CircuitBreaker的高阶装饰器功能。 您可以用隔板装饰任何Callable，Supplier，Runnable，Consumer，CheckedRunnable，CheckedSupplier，CheckedConsumer或CompletionStage。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Given
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Bulkhead</span> <span class=n>bulkhead</span> <span class=o>=</span> <span class=n>Bulkhead</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>,</span> <span class=n>config</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// When I decorate my function
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>CheckedFunction0</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>decoratedSupplier</span> <span class=o>=</span> <span class=n>Bulkhead</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>decorateCheckedSupplier</span><span class=o>(</span><span class=n>bulkhead</span><span class=o>,</span> <span class=o>()</span> <span class=o>-&gt;</span> <span class=s>&#34;This can be any method which returns: &#39;Hello&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// and chain an other function with map
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Try</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>Try</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>decoratedSupplier</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>value</span> <span class=o>-&gt;</span> <span class=n>value</span> <span class=o>+</span> <span class=s>&#34; world&#39;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Then the Try Monad returns a Success&lt;String&gt;, if all functions ran successfully.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>assertThat</span><span class=o>(</span><span class=n>result</span><span class=o>.</span><span class=na>isSuccess</span><span class=o>()).</span><span class=na>isTrue</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>assertThat</span><span class=o>(</span><span class=n>result</span><span class=o>.</span><span class=na>get</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=s>&#34;This can be any method which returns: &#39;Hello world&#39;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>assertThat</span><span class=o>(</span><span class=n>bulkhead</span><span class=o>.</span><span class=na>getMetrics</span><span class=o>().</span><span class=na>getAvailableConcurrentCalls</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>ThreadPoolBulkheadConfig</span> <span class=n>config</span> <span class=o>=</span> <span class=n>ThreadPoolBulkheadConfig</span><span class=o>.</span><span class=na>custom</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>maxThreadPoolSize</span><span class=o>(</span><span class=mi>10</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>coreThreadPoolSize</span><span class=o>(</span><span class=mi>2</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>queueCapacity</span><span class=o>(</span><span class=mi>20</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ThreadPoolBulkhead</span> <span class=n>bulkhead</span> <span class=o>=</span> <span class=n>ThreadPoolBulkhead</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>,</span> <span class=n>config</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>CompletionStage</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>supplier</span> <span class=o>=</span> <span class=n>ThreadPoolBulkhead</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>executeSupplier</span><span class=o>(</span><span class=n>bulkhead</span><span class=o>,</span> <span class=n>backendService</span><span class=o>::</span><span class=n>doSomething</span><span class=o>);</span>
</span></span></code></pre></div><p>您可以在BulkheadRegistry上注册事件使用者，并在创建，替换或删除Bulkhead时执行操作。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>BulkheadRegistry</span> <span class=n>registry</span> <span class=o>=</span> <span class=n>BulkheadRegistry</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>registry</span><span class=o>.</span><span class=na>getEventPublisher</span><span class=o>()</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>onEntryAdded</span><span class=o>(</span><span class=n>entryAddedEvent</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Bulkhead</span> <span class=n>addedBulkhead</span> <span class=o>=</span> <span class=n>entryAddedEvent</span><span class=o>.</span><span class=na>getAddedEntry</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>LOG</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Bulkhead {} added&#34;</span><span class=o>,</span> <span class=n>addedBulkhead</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>})</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>onEntryRemoved</span><span class=o>(</span><span class=n>entryRemovedEvent</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Bulkhead</span> <span class=n>removedBulkhead</span> <span class=o>=</span> <span class=n>entryRemovedEvent</span><span class=o>.</span><span class=na>getRemovedEntry</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>LOG</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Bulkhead {} removed&#34;</span><span class=o>,</span> <span class=n>removedBulkhead</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>});</span>
</span></span></code></pre></div><p>BulkHead发出BulkHeadEvents流。 发出两种类型的事件：允许执行，拒绝执行和完成执行。 如果要使用这些事件，则必须注册一个事件使用者。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>bulkhead</span><span class=o>.</span><span class=na>getEventPublisher</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>onCallPermitted</span><span class=o>(</span><span class=n>event</span> <span class=o>-&gt;</span> <span class=n>logger</span><span class=o>.</span><span class=na>info</span><span class=o>(...))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>onCallRejected</span><span class=o>(</span><span class=n>event</span> <span class=o>-&gt;</span> <span class=n>logger</span><span class=o>.</span><span class=na>info</span><span class=o>(...))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>onCallFinished</span><span class=o>(</span><span class=n>event</span> <span class=o>-&gt;</span> <span class=n>logger</span><span class=o>.</span><span class=na>info</span><span class=o>(...));</span>
</span></span></code></pre></div><h1 id=timelimiter data-numberify>TimeLimiter<a class="anchor ms-1" href=#timelimiter></a></h1><p>超时器，跟断路器一样，提供了基于内存的TimeLimiterRegistry ，可以使用该实例管理TimeLimiter</p><p>TimeLimiterRegistry timeLimiterRegistry = TimeLimiterRegistry.ofDefaults();</p><p>使用TimeLimiterConfig自定义超时器的配置，可以配置的内容有两种：</p><p>* 超时时间</p><p>* 是否调用cancle</p><p>TimeLimiterConfig config = TimeLimiterConfig.custom()</p><p>.cancelRunningFuture(true)</p><p>.timeoutDuration(Duration.ofMillis(500))</p><p>.build();</p><p>// Create a TimeLimiterRegistry with a custom global configuration</p><p>TimeLimiterRegistry timeLimiterRegistry = TimeLimiterRegistry.of(config);</p><p>// Get or create a TimeLimiter from the registry -</p><p>// TimeLimiter will be backed by the default config</p><p>TimeLimiter timeLimiterWithDefaultConfig = registry.timeLimiter(&ldquo;name1&rdquo;);</p><p>// Get or create a TimeLimiter from the registry,</p><p>// use a custom configuration when creating the TimeLimiter</p><p>TimeLimiterConfig config = TimeLimiterConfig.custom()</p><p>.cancelRunningFuture(false)</p><p>.timeoutDuration(Duration.ofMillis(1000))</p><p>.build();</p><p>TimeLimiter timeLimiterWithCustomConfig = registry.timeLimiter(&ldquo;name2&rdquo;, config);</p><p>TimeLimiter具有较高阶的装饰器函数来装饰CompletionStage或Future，以限制执行时间。</p><p>// Given I have a helloWorldService.sayHelloWorld() method which takes too long</p><p>HelloWorldService helloWorldService = mock(HelloWorldService.class);</p><p>// Create a TimeLimiter</p><p>TimeLimiter timeLimiter = TimeLimiter.of(Duration.ofSeconds(1));</p><p>// The Scheduler is needed to schedule a timeout on a non-blocking CompletableFuture</p><p>ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(3);</p><p>// The non-blocking variant with a CompletableFuture</p><p>CompletableFuture result = timeLimiter.executeCompletionStage(</p><p>scheduler, () -> CompletableFuture.supplyAsync(helloWorldService::sayHelloWorld)).toCompletableFuture();</p><p>// The blocking variant which is basically future.get(timeoutDuration, MILLISECONDS)</p><p>String result = timeLimiter.executeFutureSupplier(</p><p>() -> CompletableFuture.supplyAsync(() -> helloWorldService::sayHelloWorld));</p><h1 id=缓存 data-numberify>缓存<a class="anchor ms-1" href=#缓存></a></h1><p>以下示例显示如何使用Cache抽象装饰lambda表达式。 缓存抽象将lambda表达式的结果放入缓存实例（JCache）中，并在调用lambda表达式之前尝试从缓存中检索以前的缓存结果。 如果从分布式缓存中检索缓存失败，则会处理该异常并调用lambda表达式。</p><p>// Create a CacheContext by wrapping a JCache instance.</p><p>javax.cache.Cache&lt;String, String> cacheInstance = Caching</p><p>.getCache(&ldquo;cacheName&rdquo;, String.class, String.class);</p><p>Cache&lt;String, String> cacheContext = Cache.of(cacheInstance);</p><p>// Decorate your call to BackendService.doSomething()</p><p>CheckedFunction1&lt;String, String> cachedFunction = Decorators</p><p>.ofCheckedSupplier(() -> backendService.doSomething())</p><p>.withCache(cacheContext)</p><p>.decorate();</p><p>String value = Try.of(() -> cachedFunction.apply(&ldquo;cacheKey&rdquo;)).get();</p><p>缓存发出CacheEvents流。 事件可以是高速缓存命中，高速缓存未命中或错误。</p><p>cacheContext.getEventPublisher()</p><p>.onCacheHit(event -> logger.info(&mldr;))</p><p>.onCacheMiss(event -> logger.info(&mldr;))</p><p>.onError(event -> logger.info(&mldr;));</p><p>Ehcache 使用实例：</p><p>compile &lsquo;org.ehcache:ehcache:3.7.1&rsquo;</p><p>// Configure a cache (once)</p><p>this.cacheManager = Caching.getCachingProvider().getCacheManager();</p><p>this.cache = Cache.of(cacheManager</p><p>.createCache(&ldquo;booksCache&rdquo;, new MutableConfiguration&lt;>()));</p><p>// Get books using a cache</p><p>List books = Cache.decorateSupplier(cache, library::getBooks)</p><p>.apply(BOOKS_CACHE_KEY);</p><p>不建议在生产环境中使用JCache参考实现，因为它会导致一些并发问题。 使用Ehcache，Caffeine，Redisson，Hazelcast，Ignite或其他JCache实现。</p><h1 id=重试 data-numberify>重试<a class="anchor ms-1" href=#重试></a></h1><p>像断路器一样，提供了基于内存的RetryRegistry ：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>RetryRegistry</span> <span class=n>retryRegistry</span> <span class=o>=</span> <span class=n>RetryRegistry</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>();</span>
</span></span></code></pre></div><table><thead><tr><th>属性</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>maxAttempts</td><td>3</td><td>最大尝试次数（首次调用也被算作一次）</td></tr><tr><td>waitDuration</td><td>500 [ms]</td><td>重试之间的固定等待时间</td></tr><tr><td>intervalFunction</td><td>numOfAttempts -> waitDuration</td><td>发生故障后修改等待间隔的功能。 默认情况下，等待时间保持不变。</td></tr><tr><td>intervalBiFunction</td><td>(numOfAttempts, Either&lt;throwable, result) -> waitDuration</td><td>根据尝试次数和结果或异常修改失败后的等待间隔的功能。 与intervalFunction一起使用时，将抛出IllegalStateException。</td></tr><tr><td>retryOnResultPredicate</td><td>result -> false</td><td>配置一个谓词，该谓词评估是否应重试结果。 如果要重试结果，则谓词必须返回true，否则必须返回false。</td></tr><tr><td>retryOnExceptionPredicate</td><td>throwable -> true</td><td>配置一个谓词，该谓词评估是否应重试异常。 如果应重试异常，则谓词必须返回true，否则必须返回false。</td></tr><tr><td>retryExceptions</td><td>empty</td><td>配置Throwable类的列表，这些类被记录为失败并因此被重试。 此参数支持子类型。 注意：如果使用的是Checked Exception，则必须使用CheckedSupplier</td></tr><tr><td>ignoreExceptions</td><td>empty</td><td>配置被忽略因而不会重试的Throwable类的列表。 此参数支持子类型。</td></tr><tr><td>failAfterMaxRetries</td><td>false</td><td>当重试已达到配置的maxAttempts且结果仍未通过retryOnResultPredicate时，启用或禁用抛出MaxRetriesExceededException的布尔值</td></tr></tbody></table><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>RetryConfig</span> <span class=n>config</span> <span class=o>=</span> <span class=n>RetryConfig</span><span class=o>.</span><span class=na>custom</span><span class=o>()</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>maxAttempts</span><span class=o>(</span><span class=mi>2</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>waitDuration</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>ofMillis</span><span class=o>(</span><span class=mi>1000</span><span class=o>))</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>retryOnResult</span><span class=o>(</span><span class=n>response</span> <span class=o>-&gt;</span> <span class=n>response</span><span class=o>.</span><span class=na>getStatus</span><span class=o>()</span> <span class=o>==</span> <span class=mi>500</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>retryOnException</span><span class=o>(</span><span class=n>e</span> <span class=o>-&gt;</span> <span class=n>e</span> <span class=k>instanceof</span> <span class=n>WebServiceException</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>retryExceptions</span><span class=o>(</span><span class=n>IOException</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>TimeoutException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>ignoreExceptions</span><span class=o>(</span><span class=n>BusinessException</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>OtherBusinessException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>failAfterMaxAttempts</span><span class=o>(</span><span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=c1>// Create a RetryRegistry with a custom global configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>RetryRegistry</span> <span class=n>registry</span> <span class=o>=</span> <span class=n>RetryRegistry</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>config</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// Get or create a Retry from the registry - 
</span></span></span><span class=line><span class=cl><span class=c1>// Retry will be backed by the default config
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Retry</span> <span class=n>retryWithDefaultConfig</span> <span class=o>=</span> <span class=n>registry</span><span class=o>.</span><span class=na>retry</span><span class=o>(</span><span class=s>&#34;name1&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// Get or create a Retry from the registry, 
</span></span></span><span class=line><span class=cl><span class=c1>// use a custom configuration when creating the retry
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>RetryConfig</span> <span class=n>custom</span> <span class=o>=</span> <span class=n>RetryConfig</span><span class=o>.</span><span class=na>custom</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>waitDuration</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>ofMillis</span><span class=o>(</span><span class=mi>100</span><span class=o>))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>Retry</span> <span class=n>retryWithCustomConfig</span> <span class=o>=</span> <span class=n>registry</span><span class=o>.</span><span class=na>retry</span><span class=o>(</span><span class=s>&#34;name2&#34;</span><span class=o>,</span> <span class=n>custom</span><span class=o>);</span>
</span></span></code></pre></div><p>可以猜到，重试具有各种高级装饰器功能，就像CircuitBreaker一样。 您可以使用重试装饰任何Callable，Supplier，Runnable，Consumer，CheckedRunnable，CheckedSupplier，CheckedConsumer或CompletionStage。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Given I have a HelloWorldService which throws an exception
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>HelloWorldService</span>  <span class=n>helloWorldService</span> <span class=o>=</span> <span class=n>mock</span><span class=o>(</span><span class=n>HelloWorldService</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>given</span><span class=o>(</span><span class=n>helloWorldService</span><span class=o>.</span><span class=na>sayHelloWorld</span><span class=o>())</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>willThrow</span><span class=o>(</span><span class=k>new</span> <span class=n>WebServiceException</span><span class=o>(</span><span class=s>&#34;BAM!&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=c1>// Create a Retry with default configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Retry</span> <span class=n>retry</span> <span class=o>=</span> <span class=n>Retry</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>(</span><span class=s>&#34;id&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// Decorate the invocation of the HelloWorldService
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>CheckedFunction0</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>retryableSupplier</span> <span class=o>=</span> <span class=n>Retry</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>decorateCheckedSupplier</span><span class=o>(</span><span class=n>retry</span><span class=o>,</span> <span class=n>helloWorldService</span><span class=o>::</span><span class=n>sayHelloWorld</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// When I invoke the function
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Try</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>Try</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>retryableSupplier</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>recover</span><span class=o>((</span><span class=n>throwable</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=s>&#34;Hello world from recovery function&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// Then the helloWorldService should be invoked 3 times
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>helloWorldService</span><span class=o>).</span><span class=na>should</span><span class=o>(</span><span class=n>times</span><span class=o>(</span><span class=mi>3</span><span class=o>)).</span><span class=na>sayHelloWorld</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=c1>// and the exception should be handled by the recovery function
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>assertThat</span><span class=o>(</span><span class=n>result</span><span class=o>.</span><span class=na>get</span><span class=o>()).</span><span class=na>isEqualTo</span><span class=o>(</span><span class=s>&#34;Hello world from recovery function&#34;</span><span class=o>);</span>
</span></span></code></pre></div><p>您可以在RetryRegistry上注册事件使用者，并在创建，替换或删除重试时执行操作。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>RetryRegistry</span> <span class=n>registry</span> <span class=o>=</span> <span class=n>RetryRegistry</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>registry</span><span class=o>.</span><span class=na>getEventPublisher</span><span class=o>()</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>onEntryAdded</span><span class=o>(</span><span class=n>entryAddedEvent</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Retry</span> <span class=n>addedRetry</span> <span class=o>=</span> <span class=n>entryAddedEvent</span><span class=o>.</span><span class=na>getAddedEntry</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>LOG</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Retry {} added&#34;</span><span class=o>,</span> <span class=n>addedRetry</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>})</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>onEntryRemoved</span><span class=o>(</span><span class=n>entryRemovedEvent</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Retry</span> <span class=n>removedRetry</span> <span class=o>=</span> <span class=n>entryRemovedEvent</span><span class=o>.</span><span class=na>getRemovedEntry</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>LOG</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Retry {} removed&#34;</span><span class=o>,</span> <span class=n>removedRetry</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>});</span>
</span></span></code></pre></div><p>如果不想在重试尝试之间使用固定的等待时间，则可以配置一个IntervalFunction，该函数用于计算每次尝试的等待时间。 Resilience4j提供了几种工厂方法来简化IntervalFunction的创建。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>IntervalFunction</span> <span class=n>defaultWaitInterval</span> <span class=o>=</span> <span class=n>IntervalFunction</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>ofDefaults</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=c1>// This interval function is used internally 
</span></span></span><span class=line><span class=cl><span class=c1>// when you only configure waitDuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>IntervalFunction</span> <span class=n>fixedWaitInterval</span> <span class=o>=</span> <span class=n>IntervalFunction</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>ofSeconds</span><span class=o>(</span><span class=mi>5</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=n>IntervalFunction</span> <span class=n>intervalWithExponentialBackoff</span> <span class=o>=</span> <span class=n>IntervalFunction</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>ofExponentialBackoff</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>IntervalFunction</span> <span class=n>intervalWithCustomExponentialBackoff</span> <span class=o>=</span> <span class=n>IntervalFunction</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>ofExponentialBackoff</span><span class=o>(</span><span class=n>IntervalFunction</span><span class=o>.</span><span class=na>DEFAULT_INITIAL_INTERVAL</span><span class=o>,</span> <span class=mi>2</span><span class=n>d</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>IntervalFunction</span> <span class=n>randomWaitInterval</span> <span class=o>=</span> <span class=n>IntervalFunction</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>ofRandomized</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=c1>// Overwrite the default intervalFunction with your custom one
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>RetryConfig</span> <span class=n>retryConfig</span> <span class=o>=</span> <span class=n>RetryConfig</span><span class=o>.</span><span class=na>custom</span><span class=o>()</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>intervalFunction</span><span class=o>(</span><span class=n>intervalWithExponentialBackoff</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span></code></pre></div><h1 id=ratelimiter data-numberify>RateLimiter<a class="anchor ms-1" href=#ratelimiter></a></h1><p>速率限制是一项必不可少的技术，它可以为扩展您的API做好准备并建立服务的高可用性和可靠性。 而且，此技术还提供了很多不同的选择，例如如何处理检测到的限制超额，或您要限制哪种类型的请求。 您可以简单地拒绝此超限请求，或建立队列以稍后执行它们，或以某种方式组合这两种方法。</p><p>Resilience4j提供了一个RateLimiter，它将从纪元开始将所有纳秒级分为多个周期。 每个周期都有一个由RateLimiterConfig.limitRefreshPeriod配置的持续时间。 在每个周期的开始，RateLimiter会将活动许可的数量设置为RateLimiterConfig.limitForPeriod。</p><p>RateLimiter的默认实现是AtomicRateLimiter，它通过AtomicReference管理其状态。 AtomicRateLimiter.State是完全不可变的，并且具有以下字段：</p><p>* activeCycle : 上次调用使用的cycle号</p><p>* activePermissions :上次call后的可用权限计数。如果保留某些权限，则可以为负</p><p>* nanosToWait :等待上一次call的等待时间（以纳秒为单位）</p><p>还有一个使用信号量的SemaphoreBasedRateLimiter和一个计划程序，该计划程序将在每个RateLimiterConfig＃limitRefreshPeriod之后刷新权限。</p><p>创建默认的速率器：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>RateLimiterRegistry</span> <span class=n>rateLimiterRegistry</span> <span class=o>=</span> <span class=n>RateLimiterRegistry</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>();</span>
</span></span></code></pre></div><p>RateLimiterConfig配置速率器：</p><table><thead><tr><th>属性</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>timeoutDuration</td><td>5 [s]</td><td>线程等待权限的默认等待时间</td></tr><tr><td>limitRefreshPeriod</td><td>500 [ns]</td><td>限制刷新的时间段。 在每个时间段之后，速率限制器将其权限计数重新设置为limitForPeriod值</td></tr><tr><td>limitForPeriod</td><td>50</td><td>一个限制刷新期间可用的权限数</td></tr></tbody></table><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>RateLimiterConfig</span> <span class=n>config</span> <span class=o>=</span> <span class=n>RateLimiterConfig</span><span class=o>.</span><span class=na>custom</span><span class=o>()</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>limitRefreshPeriod</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>ofMillis</span><span class=o>(</span><span class=mi>1</span><span class=o>))</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>limitForPeriod</span><span class=o>(</span><span class=mi>10</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>timeoutDuration</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>ofMillis</span><span class=o>(</span><span class=mi>25</span><span class=o>))</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=c1>// Create registry
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>RateLimiterRegistry</span> <span class=n>rateLimiterRegistry</span> <span class=o>=</span> <span class=n>RateLimiterRegistry</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>config</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// Use registry
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>RateLimiter</span> <span class=n>rateLimiterWithDefaultConfig</span> <span class=o>=</span> <span class=n>rateLimiterRegistry</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>rateLimiter</span><span class=o>(</span><span class=s>&#34;name1&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>RateLimiter</span> <span class=n>rateLimiterWithCustomConfig</span> <span class=o>=</span> <span class=n>rateLimiterRegistry</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>rateLimiter</span><span class=o>(</span><span class=s>&#34;name2&#34;</span><span class=o>,</span> <span class=n>config</span><span class=o>);</span>
</span></span></code></pre></div><p>如您所料，RateLimiter具有各种类似于CircuitBreaker的高阶装饰器功能。 您可以使用RateLimiter装饰任何Callable，Supplier，Runnable，Consumer，CheckedRunnable，CheckedSupplier，CheckedConsumer或CompletionStage。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Decorate your call to BackendService.doSomething()
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>CheckedRunnable</span> <span class=n>restrictedCall</span> <span class=o>=</span> <span class=n>RateLimiter</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>decorateCheckedRunnable</span><span class=o>(</span><span class=n>rateLimiter</span><span class=o>,</span> <span class=n>backendService</span><span class=o>::</span><span class=n>doSomething</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>Try</span><span class=o>.</span><span class=na>run</span><span class=o>(</span><span class=n>restrictedCall</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>andThenTry</span><span class=o>(</span><span class=n>restrictedCall</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>onFailure</span><span class=o>((</span><span class=n>RequestNotPermitted</span> <span class=n>throwable</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=n>LOG</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Wait before call it again :)&#34;</span><span class=o>));</span>
</span></span></code></pre></div><p>您可以使用changeTimeoutDuration和changeLimitForPeriod方法在运行时更改速率限制器参数。</p><p>新的超时时间不会影响当前正在等待许可的线程。</p><p>新的限制不会影响当前期限的权限，并且仅从下一个限制开始适用。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Decorate your call to BackendService.doSomething()
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>CheckedRunnable</span> <span class=n>restrictedCall</span> <span class=o>=</span> <span class=n>RateLimiter</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>decorateCheckedRunnable</span><span class=o>(</span><span class=n>rateLimiter</span><span class=o>,</span> <span class=n>backendService</span><span class=o>::</span><span class=n>doSomething</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// during second refresh cycle limiter will get 100 permissions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>rateLimiter</span><span class=o>.</span><span class=na>changeLimitForPeriod</span><span class=o>(</span><span class=mi>100</span><span class=o>);</span>
</span></span></code></pre></div><p>您可以在RateLimiterRegistry上注册事件使用者，并在创建，替换或删除RateLimiter时执行操作。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>RateLimiterRegistry</span> <span class=n>registry</span> <span class=o>=</span> <span class=n>RateLimiterRegistry</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>registry</span><span class=o>.</span><span class=na>getEventPublisher</span><span class=o>()</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>onEntryAdded</span><span class=o>(</span><span class=n>entryAddedEvent</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>RateLimiter</span> <span class=n>addedRateLimiter</span> <span class=o>=</span> <span class=n>entryAddedEvent</span><span class=o>.</span><span class=na>getAddedEntry</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>LOG</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;RateLimiter {} added&#34;</span><span class=o>,</span> <span class=n>addedRateLimiter</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>})</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>onEntryRemoved</span><span class=o>(</span><span class=n>entryRemovedEvent</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>RateLimiter</span> <span class=n>removedRateLimiter</span> <span class=o>=</span> <span class=n>entryRemovedEvent</span><span class=o>.</span><span class=na>getRemovedEntry</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>LOG</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;RateLimiter {} removed&#34;</span><span class=o>,</span> <span class=n>removedRateLimiter</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>});</span>
</span></span></code></pre></div><p>RateLimiter发出RateLimiterEvents流。 事件可以是成功的许可获取或获取失败。</p><p>所有事件都包含其他信息，例如事件创建时间和速率限制器名称。</p><p>如果要使用事件，则必须注册事件使用者。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>rateLimiter</span><span class=o>.</span><span class=na>getEventPublisher</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>onSuccess</span><span class=o>(</span><span class=n>event</span> <span class=o>-&gt;</span> <span class=n>logger</span><span class=o>.</span><span class=na>info</span><span class=o>(...))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>onFailure</span><span class=o>(</span><span class=n>event</span> <span class=o>-&gt;</span> <span class=n>logger</span><span class=o>.</span><span class=na>info</span><span class=o>(...));</span>
</span></span></code></pre></div><p>您可以通过自定义实现覆盖内存RegistryStore。 例如，如果要使用在一定时间后删除未使用实例的缓存。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>RateLimiterRegistry</span> <span class=n>rateLimiterRegistry</span> <span class=o>=</span> <span class=n>RateLimiterRegistry</span><span class=o>.</span><span class=na>custom</span><span class=o>()</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>withRegistryStore</span><span class=o>(</span><span class=k>new</span> <span class=n>CacheRateLimiterRegistryStore</span><span class=o>())</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span></code></pre></div><h1 id=和spring-boot结合 data-numberify>和spring boot结合<a class="anchor ms-1" href=#和spring-boot结合></a></h1><h2 id=依赖 data-numberify>依赖<a class="anchor ms-1" href=#依赖></a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>repositories</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>jCenter</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dependencies</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>compile</span> <span class=s2>&#34;io.github.resilience4j:resilience4j-spring-boot2:${resilience4jVersion}&#34;</span>
</span></span><span class=line><span class=cl>  <span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.springframework.boot:spring-boot-starter-actuator&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.springframework.boot:spring-boot-starter-aop&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=相关配置 data-numberify>相关配置<a class="anchor ms-1" href=#相关配置></a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>resilience4j.circuitbreaker</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>instances</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backendA</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>registerHealthIndicator</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>slidingWindowSize</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backendB</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>registerHealthIndicator</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>slidingWindowSize</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>permittedNumberOfCallsInHalfOpenState</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>slidingWindowType</span><span class=p>:</span><span class=w> </span><span class=l>TIME_BASED</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>minimumNumberOfCalls</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>waitDurationInOpenState</span><span class=p>:</span><span class=w> </span><span class=l>50s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>failureRateThreshold</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>eventConsumerBufferSize</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>recordFailurePredicate</span><span class=p>:</span><span class=w> </span><span class=l>io.github.robwin.exception.RecordFailurePredicate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resilience4j.retry</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>instances</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backendA</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>maxAttempts</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>waitDuration</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>enableExponentialBackoff</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>exponentialBackoffMultiplier</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>retryExceptions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>org.springframework.web.client.HttpServerErrorException</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>java.io.IOException</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ignoreExceptions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>io.github.robwin.exception.BusinessException</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backendB</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>maxAttempts</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>waitDuration</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>retryExceptions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>org.springframework.web.client.HttpServerErrorException</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>java.io.IOException</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ignoreExceptions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>io.github.robwin.exception.BusinessException</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resilience4j.bulkhead</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>instances</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backendA</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>maxConcurrentCalls</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backendB</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>maxWaitDuration</span><span class=p>:</span><span class=w> </span><span class=l>10ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>maxConcurrentCalls</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resilience4j.thread-pool-bulkhead</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>instances</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>backendC</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>maxThreadPoolSize</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>coreThreadPoolSize</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>queueCapacity</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resilience4j.ratelimiter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>instances</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backendA</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>limitForPeriod</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>limitRefreshPeriod</span><span class=p>:</span><span class=w> </span><span class=l>1s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>timeoutDuration</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>registerHealthIndicator</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>eventConsumerBufferSize</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backendB</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>limitForPeriod</span><span class=p>:</span><span class=w> </span><span class=m>6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>limitRefreshPeriod</span><span class=p>:</span><span class=w> </span><span class=l>500ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>timeoutDuration</span><span class=p>:</span><span class=w> </span><span class=l>3s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resilience4j.timelimiter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>instances</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backendA</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>timeoutDuration</span><span class=p>:</span><span class=w> </span><span class=l>2s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cancelRunningFuture</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backendB</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>timeoutDuration</span><span class=p>:</span><span class=w> </span><span class=l>1s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cancelRunningFuture</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span></code></pre></div><p>你可以覆盖默认配置、定义共享配置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>resilience4j.circuitbreaker</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>slidingWindowSize</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>permittedNumberOfCallsInHalfOpenState</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>waitDurationInOpenState</span><span class=p>:</span><span class=w> </span><span class=m>10000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>failureRateThreshold</span><span class=p>:</span><span class=w> </span><span class=m>60</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>eventConsumerBufferSize</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>registerHealthIndicator</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>someShared</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>slidingWindowSize</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>permittedNumberOfCallsInHalfOpenState</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>instances</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backendA</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>baseConfig</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>waitDurationInOpenState</span><span class=p>:</span><span class=w> </span><span class=m>5000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backendB</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>baseConfig</span><span class=p>:</span><span class=w> </span><span class=l>someShared</span><span class=w>
</span></span></span></code></pre></div><p>你还可以通过代码覆盖yaml中的配置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>CircuitBreakerConfigCustomizer</span> <span class=nf>testCustomizer</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>CircuitBreakerConfigCustomizer</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;backendA&#34;</span><span class=o>,</span> <span class=n>builder</span> <span class=o>-&gt;</span> <span class=n>builder</span><span class=o>.</span><span class=na>slidingWindowSize</span><span class=o>(</span><span class=mi>100</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Resilience4j 提供了自定义配置的类：</p><table><thead><tr><th>Resilienc4j Type</th><th>Instance Customizer class</th></tr></thead><tbody><tr><td>Circuit breaker</td><td>CircuitBreakerConfigCustomizer</td></tr><tr><td>Retry</td><td>RetryConfigCustomizer</td></tr><tr><td>Rate limiter</td><td>RateLimiterConfigCustomizer</td></tr><tr><td>Bulkhead</td><td>BulkheadConfigCustomizer</td></tr><tr><td>ThreadPoolBulkhead</td><td>ThreadPoolBulkheadConfigCustomizer</td></tr><tr><td>Time Limiter</td><td>TimeLimiterConfigCustomizer</td></tr></tbody></table><h2 id=注解 data-numberify>注解<a class="anchor ms-1" href=#注解></a></h2><p>spring boot提供了注解支持，这些注解标注的方法的返回值可以是异步或同步的</p><p>Bulkhead注解的type属性可以指定采用何种类型的隔离器，默认是semaphore ：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bulkhead</span><span class=o>(</span><span class=n>name</span> <span class=o>=</span> <span class=n>BACKEND</span><span class=o>,</span> <span class=n>type</span> <span class=o>=</span> <span class=n>Bulkhead</span><span class=o>.</span><span class=na>Type</span><span class=o>.</span><span class=na>THREADPOOL</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=nf>doSomethingAsync</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>500</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>CompletableFuture</span><span class=o>.</span><span class=na>completedFuture</span><span class=o>(</span><span class=s>&#34;Test&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=nd>@CircuitBreaker</span><span class=o>(</span><span class=n>name</span> <span class=o>=</span> <span class=n>BACKEND</span><span class=o>,</span> <span class=n>fallbackMethod</span> <span class=o>=</span> <span class=s>&#34;fallback&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@RateLimiter</span><span class=o>(</span><span class=n>name</span> <span class=o>=</span> <span class=n>BACKEND</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@Bulkhead</span><span class=o>(</span><span class=n>name</span> <span class=o>=</span> <span class=n>BACKEND</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@Retry</span><span class=o>(</span><span class=n>name</span> <span class=o>=</span> <span class=n>BACKEND</span><span class=o>,</span> <span class=n>fallbackMethod</span> <span class=o>=</span> <span class=s>&#34;fallback&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@TimeLimiter</span><span class=o>(</span><span class=n>name</span> <span class=o>=</span> <span class=n>BACKEND</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Mono</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=nf>method</span><span class=o>(</span><span class=n>String</span> <span class=n>param1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Mono</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=k>new</span> <span class=n>NumberFormatException</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>Mono</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=nf>fallback</span><span class=o>(</span><span class=n>String</span> <span class=n>param1</span><span class=o>,</span> <span class=n>IllegalArgumentException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Mono</span><span class=o>.</span><span class=na>just</span><span class=o>(</span><span class=s>&#34;test&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>Mono</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=nf>fallback</span><span class=o>(</span><span class=n>String</span> <span class=n>param1</span><span class=o>,</span> <span class=n>RuntimeException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Mono</span><span class=o>.</span><span class=na>just</span><span class=o>(</span><span class=s>&#34;test&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>需要注意的是，fallback必须放在同个类中，并且有相同的方法签名并追加一个异常参数。</p><p>如果有多个fallback方法，则最近的方法会执行，例如上面的方法抛出 NumberFormatException，IllegalArgumentException方法会执行。</p><p>仅当多个方法具有相同的返回类型，并且您要一劳永逸地为它们定义相同的后备方法时，才可以使用异常参数定义一个全局后备方法。</p><h3 id=注解的顺序 data-numberify>注解的顺序<a class="anchor ms-1" href=#注解的顺序></a></h3><pre tabindex=0><code>Retry ( CircuitBreaker ( RateLimiter ( TimeLimiter ( Bulkhead ( Function ) ) ) ) )
</code></pre><p>如果需要其他顺序，则必须使用功能链样式而不是Spring批注样式，或使用以下属性来显式设置外观顺序：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=l>resilience4j.retry.retryAspectOrder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>resilience4j.circuitbreaker.circuitBreakerAspectOrder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>resilience4j.ratelimiter.rateLimiterAspectOrder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>resilience4j.timelimiter.timeLimiterAspectOrder</span><span class=w>
</span></span></span></code></pre></div><p>例如，让短路器在重试器后执行，你必须设置<code>retryAspectOrder</code> 的值大于<code>circuitBreakerAspectOrder</code> ：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>resilience4j</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>circuitbreaker</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>circuitBreakerAspectOrder</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>retry</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>retryAspectOrder</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span></code></pre></div><h2 id=指标端点 data-numberify>指标端点<a class="anchor ms-1" href=#指标端点></a></h2><pre tabindex=0><code>/actuator/metrics
{
    &#34;names&#34;: [
        &#34;resilience4j.circuitbreaker.calls&#34;,
        &#34;resilience4j.circuitbreaker.buffered.calls&#34;,
        &#34;resilience4j.circuitbreaker.state&#34;,
        &#34;resilience4j.circuitbreaker.failure.rate&#34;
        ]
}
</code></pre><p>获取具体的指标信息，<code>GET /actuator/metrics/{metric.name}</code>,例如：<code>/actuator/metrics/resilience4j.circuitbreaker.calls</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;resilience4j.circuitbreaker.calls&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;measurements&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;statistic&#34;</span><span class=p>:</span> <span class=s2>&#34;VALUE&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;availableTags&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;tag&#34;</span><span class=p>:</span> <span class=s2>&#34;kind&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;values&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;not_permitted&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;successful&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;failed&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;tag&#34;</span><span class=p>:</span> <span class=s2>&#34;name&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;values&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;backendB&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;backendA&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>如果想要使用 prometheus，需要添加依赖 io.micrometer:micrometer-registry-prometheus，端点是/actuator/prometheus</p><h3 id=health-端点 data-numberify>health 端点<a class="anchor ms-1" href=#health-端点></a></h3><p>默认，CircuitBreaker 和 RateLimiter 的health端点是禁用的。当CircuitBreaker打开时，由于应用程序状态为DOWN，因此会禁用运行状况指示器。 这可能不是您想要实现的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>management.health.circuitbreakers.enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>management.health.ratelimiters.enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resilience4j.circuitbreaker</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>registerHealthIndicator</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resilience4j.ratelimiter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>registerHealthIndicator</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><p>闭合的CircuitBreaker状态映射为UP，打开状态映射为DOWN，半打开状态映射为UNKNOWN。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;UP&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;details&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;circuitBreakers&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;UP&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;details&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;backendB&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;UP&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;details&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;failureRate&#34;</span><span class=p>:</span> <span class=s2>&#34;-1.0%&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;failureRateThreshold&#34;</span><span class=p>:</span> <span class=s2>&#34;50.0%&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;slowCallRate&#34;</span><span class=p>:</span> <span class=s2>&#34;-1.0%&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;slowCallRateThreshold&#34;</span><span class=p>:</span> <span class=s2>&#34;100.0%&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;bufferedCalls&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;slowCalls&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;slowFailedCalls&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;failedCalls&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;notPermittedCalls&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;state&#34;</span><span class=p>:</span> <span class=s2>&#34;CLOSED&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;backendA&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;UP&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;details&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;failureRate&#34;</span><span class=p>:</span> <span class=s2>&#34;-1.0%&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;failureRateThreshold&#34;</span><span class=p>:</span> <span class=s2>&#34;50.0%&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;slowCallRate&#34;</span><span class=p>:</span> <span class=s2>&#34;-1.0%&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;slowCallRateThreshold&#34;</span><span class=p>:</span> <span class=s2>&#34;100.0%&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;bufferedCalls&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;slowCalls&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;slowFailedCalls&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;failedCalls&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;notPermittedCalls&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;state&#34;</span><span class=p>:</span> <span class=s2>&#34;CLOSED&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=events端点 data-numberify>events端点<a class="anchor ms-1" href=#events端点></a></h3><p>发出的CircuitBreaker，Retry，RateLimiter，Bulkhead和TimeLimiter事件存储在单独的循环事件消费者缓冲区中。 可以在application.yml文件（eventConsumerBufferSize）中配置事件消费者缓冲区的大小。</p><p>端点 <code>/ctuator/circuitbreakers</code> 列出了所有CircuitBreaker实例的名称。 该端点也可用于Retry，RateLimiter，Bulkhead和TimeLimiter。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;circuitBreakers&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;backendA&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;backendB&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>端点/ actuator / circuitbreakerevents默认情况下列出所有CircuitBreaker实例的最近100个发出的事件。 该端点也可用于Retry，RateLimiter，Bulkhead和TimeLimiter。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;circuitBreakerEvents&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;circuitBreakerName&#34;</span><span class=p>:</span> <span class=s2>&#34;backendA&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;ERROR&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;creationTime&#34;</span><span class=p>:</span> <span class=s2>&#34;2017-01-10T15:39:17.117+01:00[Europe/Berlin]&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;errorMessage&#34;</span><span class=p>:</span> <span class=s2>&#34;org.springframework.web.client.HttpServerErrorException: 500 This is a remote exception&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;durationInMs&#34;</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;circuitBreakerName&#34;</span><span class=p>:</span> <span class=s2>&#34;backendA&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;SUCCESS&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;creationTime&#34;</span><span class=p>:</span> <span class=s2>&#34;2017-01-10T15:39:20.518+01:00[Europe/Berlin]&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;durationInMs&#34;</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;circuitBreakerName&#34;</span><span class=p>:</span> <span class=s2>&#34;backendB&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;ERROR&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;creationTime&#34;</span><span class=p>:</span> <span class=s2>&#34;2017-01-10T15:41:31.159+01:00[Europe/Berlin]&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;errorMessage&#34;</span><span class=p>:</span> <span class=s2>&#34;org.springframework.web.client.HttpServerErrorException: 500 This is a remote exception&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;durationInMs&#34;</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;circuitBreakerName&#34;</span><span class=p>:</span> <span class=s2>&#34;backendB&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;SUCCESS&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;creationTime&#34;</span><span class=p>:</span> <span class=s2>&#34;2017-01-10T15:41:33.526+01:00[Europe/Berlin]&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;durationInMs&#34;</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h1 id=spring-cloud-结合 data-numberify>spring cloud 结合<a class="anchor ms-1" href=#spring-cloud-结合></a></h1><p>将Spring Cloud 2 Starter of Resilience4j添加到您的编译依赖项中。</p><p>Spring Cloud 2 Starter允许您将Spring Cloud Config用作在运行时管理和刷新属性。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>repositories</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>jCenter</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dependencies</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>compile</span> <span class=s>&#34;io.github.resilience4j:resilience4j-spring-cloud2:${resilience4jVersion}&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>compile</span><span class=o>(</span><span class=err>&#39;</span><span class=n>org</span><span class=o>.</span><span class=na>springframework</span><span class=o>.</span><span class=na>boot</span><span class=o>:</span><span class=n>spring</span><span class=o>-</span><span class=n>boot</span><span class=o>-</span><span class=n>starter</span><span class=o>-</span><span class=n>actuator</span><span class=err>&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>compile</span><span class=o>(</span><span class=err>&#39;</span><span class=n>org</span><span class=o>.</span><span class=na>springframework</span><span class=o>.</span><span class=na>boot</span><span class=o>:</span><span class=n>spring</span><span class=o>-</span><span class=n>boot</span><span class=o>-</span><span class=n>starter</span><span class=o>-</span><span class=n>aop</span><span class=err>&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>compile</span><span class=o>(</span><span class=err>&#39;</span><span class=n>org</span><span class=o>.</span><span class=na>springframework</span><span class=o>.</span><span class=na>cloud</span><span class=o>:</span><span class=n>spring</span><span class=o>-</span><span class=n>cloud</span><span class=o>-</span><span class=n>starter</span><span class=o>-</span><span class=n>config</span><span class=err>&#39;</span><span class=o>)</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h1 id=和feign结合 data-numberify>和feign结合<a class="anchor ms-1" href=#和feign结合></a></h1><p>当前仅支持断路器、限流器和fallback.</p><h2 id=装扮接口 data-numberify>装扮接口<a class="anchor ms-1" href=#装扮接口></a></h2><p>Resilience4jFeign.builder是用于创建feign的容错实例的主要类。</p><p>它扩展了Feign.builder，添加自定义InvocationHandlerFactory。 Resilience4jFeign使用其自己的InvocationHandlerFactory来应用装饰器。 可以使用FeignDecorators类来构建装饰器。 可以组合多个装饰器。</p><p>以下示例显示如何使用RateLimiter和CircuitBreaker装饰feign接口：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>MyService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nd>@RequestLine</span><span class=o>(</span><span class=s>&#34;GET /greeting&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=nf>getGreeting</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nd>@RequestLine</span><span class=o>(</span><span class=s>&#34;POST /greeting&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=nf>createGreeting</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>CircuitBreaker</span> <span class=n>circuitBreaker</span> <span class=o>=</span> <span class=n>CircuitBreaker</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>(</span><span class=s>&#34;backendName&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>RateLimiter</span> <span class=n>rateLimiter</span> <span class=o>=</span> <span class=n>RateLimiter</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>(</span><span class=s>&#34;backendName&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>FeignDecorators</span> <span class=n>decorators</span> <span class=o>=</span> <span class=n>FeignDecorators</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                                 <span class=o>.</span><span class=na>withRateLimiter</span><span class=o>(</span><span class=n>rateLimiter</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                                 <span class=o>.</span><span class=na>withCircuitBreaker</span><span class=o>(</span><span class=n>circuitBreaker</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                                 <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>MyService</span> <span class=n>myService</span> <span class=o>=</span> <span class=n>Resilience4jFeign</span><span class=o>.</span><span class=na>builder</span><span class=o>(</span><span class=n>decorators</span><span class=o>).</span><span class=na>target</span><span class=o>(</span><span class=n>MyService</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=s>&#34;http://localhost:8080/&#34;</span><span class=o>);</span>
</span></span></code></pre></div><p>调用MyService实例的任何方法将先调用CircuitBreaker，然后再调用RateLimiter。</p><p>如果这些机制之一生效，则将引发相应的RuntimeException，例如CircuitBreakerOpenException或RequestNotPermitted（提示：这些不会扩展FeignException类）。<picture><img class=img-fluid alt=img src loading=lazy></picture></p><h2 id=装扮器的顺序 data-numberify>装扮器的顺序<a class="anchor ms-1" href=#装扮器的顺序></a></h2><p>装饰器的应用顺序与声明它们的顺序相对应。</p><p>在构建FeignDecorators时，请注意这一点，因为顺序会影响最终的行为，这一点很重要。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>FeignDecorators</span> <span class=n>decoratorsA</span> <span class=o>=</span> <span class=n>FeignDecorators</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                                         <span class=o>.</span><span class=na>withCircuitBreaker</span><span class=o>(</span><span class=n>circuitBreaker</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                                         <span class=o>.</span><span class=na>withRateLimiter</span><span class=o>(</span><span class=n>rateLimiter</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                                         <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                         
</span></span><span class=line><span class=cl>        <span class=n>FeignDecorators</span> <span class=n>decoratorsB</span> <span class=o>=</span> <span class=n>FeignDecorators</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                                         <span class=o>.</span><span class=na>withRateLimiter</span><span class=o>(</span><span class=n>rateLimiter</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                                         <span class=o>.</span><span class=na>withCircuitBreaker</span><span class=o>(</span><span class=n>circuitBreaker</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                                         <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span></code></pre></div><p>使用decoratorsA时，将在CircuitBreaker之前调用RateLimiter。 这意味着即使CircuitBreaker打开，RateLimiter仍将限制呼叫速率。 decoratorsB应用相反的顺序。 这意味着一旦CircuitBreaker打开，RateLimiter将不再起作用。</p><h2 id=fallback data-numberify>Fallback<a class="anchor ms-1" href=#fallback></a></h2><p>可以定义在抛出异常时调用的fallback。 当HTTP请求失败时，也可能在FeignDecorators中的一个激活时，例如CircuitBreaker，就会发生异常。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>MyService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nd>@RequestLine</span><span class=o>(</span><span class=s>&#34;GET /greeting&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=nf>greeting</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>MyService</span> <span class=n>requestFailedFallback</span> <span class=o>=</span> <span class=o>()</span> <span class=o>-&gt;</span> <span class=s>&#34;fallback greeting&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=n>MyService</span> <span class=n>circuitBreakerFallback</span> <span class=o>=</span> <span class=o>()</span> <span class=o>-&gt;</span> <span class=s>&#34;CircuitBreaker is open!&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=n>CircuitBreaker</span> <span class=n>circuitBreaker</span> <span class=o>=</span> <span class=n>CircuitBreaker</span><span class=o>.</span><span class=na>ofDefaults</span><span class=o>(</span><span class=s>&#34;backendName&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>FeignDecorators</span> <span class=n>decorators</span> <span class=o>=</span> <span class=n>FeignDecorators</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                         <span class=o>.</span><span class=na>withFallback</span><span class=o>(</span><span class=n>requestFailedFallback</span><span class=o>,</span> <span class=n>FeignException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                         <span class=o>.</span><span class=na>withFallback</span><span class=o>(</span><span class=n>circuitBreakerFallback</span><span class=o>,</span> <span class=n>CircuitBreakerOpenException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                         <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>MyService</span> <span class=n>myService</span> <span class=o>=</span> <span class=n>Resilience4jFeign</span><span class=o>.</span><span class=na>builder</span><span class=o>(</span><span class=n>decorators</span><span class=o>).</span><span class=na>target</span><span class=o>(</span><span class=n>MyService</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=s>&#34;http://localhost:8080/&#34;</span><span class=o>,</span> <span class=n>fallback</span><span class=o>);</span>
</span></span></code></pre></div><p>在此示例中，当抛出FeignException时（通常在HTTP请求失败时）将调用requestFailedFallback，而仅在CircuitBreakerOpenException情况下才调用circuitBreakerFallback。 检查FeignDecorators类，以了解更多过滤后备的方法。</p><p>所有回退必须实现在“目标”（Resilience4jFeign.Builder＃target）方法中声明的相同接口，否则将抛出IllegalArgumentException。</p><p>可以分配多个回退来处理相同的Exception，并在前一个失败时调用下一个回退。</p><p>如果需要，回退可以消耗抛出的Exception。 如果回退取决于异常可能具有不同的行为，或者仅记录异常，这将很有用。</p><p>请注意，将为抛出的每个异常实例化这种回退。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>MyService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nd>@RequestLine</span><span class=o>(</span><span class=s>&#34;GET /greeting&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=nf>greeting</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>class</span> <span class=nc>MyFallback</span> <span class=kd>implements</span> <span class=n>MyService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>private</span> <span class=n>Exception</span> <span class=n>cause</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=nf>MyFallback</span><span class=o>(</span><span class=n>Exception</span> <span class=n>cause</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=o>.</span><span class=na>cause</span> <span class=o>=</span> <span class=n>cause</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=n>String</span> <span class=nf>greeting</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>cause</span> <span class=n>instanceOf</span> <span class=n>FeignException</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=s>&#34;Feign Exception&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=s>&#34;Other exception&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>FeignDecorators</span> <span class=n>decorators</span> <span class=o>=</span> <span class=n>FeignDecorators</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>withFallbackFactory</span><span class=o>(</span><span class=n>MyFallback</span><span class=o>::</span><span class=k>new</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span></code></pre></div></div></div></div><div class=card-footer><div class="post-navs d-flex justify-content-evenly"><div class="post-nav post-prev"><i class="fas fa-fw fa-chevron-down post-prev-icon me-1" data-fa-transform=rotate-90></i>
<a href=/myblog/blog/2022/12/spring-cloud-circuit-breaker/>Spring-Cloud-Circuit-Breaker</a></div><div class="post-nav post-next"><a href=/myblog/blog/2022/12/spring-mvc/>Spring-Mvc</a>
<i class="fas fa-fw fa-chevron-down post-next-icon ms-1" data-fa-transform=rotate-270></i></div></div></div></article><section class="related-posts row card component"><div class=card-header><h2 class="card-title fs-4 my-2 text-surface">相关文章</h2></div><div class="card-body slide px-1"><div class="slide-inner row gx-0"><div class="col-12 col-md-6 col-lg-4 me-2"><div class="post-card card card-body p-0 border-0 surface"><div class="post-card-default-img card-img-top d-flex align-items-center justify-content-center bg-body-secondary mb-1">NO IMAGE</div><a class=post-title href=/myblog/blog/2022/12/spring-cloud-circuit-breaker/>Spring-Cloud-Circuit-Breaker</a><div class="post-meta mb-0">2022年12月2日</div></div></div><div class="col-12 col-md-6 col-lg-4 me-2"><div class="post-card card card-body p-0 border-0 surface"><div class="post-card-default-img card-img-top d-flex align-items-center justify-content-center bg-body-secondary mb-1">NO IMAGE</div><a class=post-title href=/myblog/blog/2022/12/spring-cloud-loadbalancer/>Spring-Cloud-LoadBalancer</a><div class="post-meta mb-0">2022年12月2日</div></div></div><div class="col-12 col-md-6 col-lg-4 me-2"><div class="post-card card card-body p-0 border-0 surface"><div class="post-card-default-img card-img-top d-flex align-items-center justify-content-center bg-body-secondary mb-1">NO IMAGE</div><a class=post-title href=/myblog/blog/2022/12/spring-cloud-discovery/>Spring-Cloud-Discovery</a><div class="post-meta mb-0">2022年12月2日</div></div></div><div class="col-12 col-md-6 col-lg-4 me-2"><div class="post-card card card-body p-0 border-0 surface"><div class="post-card-default-img card-img-top d-flex align-items-center justify-content-center bg-body-secondary mb-1">NO IMAGE</div><a class=post-title href=/myblog/blog/2022/12/nginx/>Nginx</a><div class="post-meta mb-0">2022年12月2日</div></div></div><div class="col-12 col-md-6 col-lg-4 me-2"><div class="post-card card card-body p-0 border-0 surface"><div class="post-card-default-img card-img-top d-flex align-items-center justify-content-center bg-body-secondary mb-1">NO IMAGE</div><a class=post-title href=/myblog/blog/2022/12/spring-security/>Spring-Security</a><div class="post-meta mb-0">2022年12月2日</div></div></div></div><button class=slide-control-left>
<i class="fas fa-2x fa-chevron-circle-down" data-fa-transform=rotate-90></i>
<span class=visually-hidden>Left</span></button>
<button class=slide-control-right>
<i class="fas fa-2x fa-chevron-circle-down" data-fa-transform=rotate-270></i>
<span class=visually-hidden>Right</span></button></div></section><div class="card component row post-comments" id=post-comments><div class=card-header><h2 class="card-title my-2 fs-4 text-surface">评论</h2></div><div class=card-body></div></div></div></div><aside class="col-xxl-4 sidebar d-flex"><div class="container d-flex flex-column"><div class="accordion profile"><div class="accordion-item card row text-center component"><div class="accordion-header card-header border-0" id=profile-header><a class="accordion-button d-lg-none mb-2 shadow-none p-0 bg-transparent text-surface collapsed" role=button data-bs-toggle=collapse href=#profile aria-expanded=false aria-controls=profile>Profile</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block" id=profile aria-labelledby=profile-header><div class="col-12 d-flex align-items-center justify-content-center"><picture><img class="profile-avatar rounded-circle" alt=小胖子 src=https://banrenshan.github.io/myblog/images/profile.webp loading=lazy data-viewer-invisible width=400 height=400></picture></div><div class="col-12 profile-meta"><div class="profile-name fw-fold fs-lg">小胖子</div><div class=profile-bio>每天一点点</div></div></div></div></div><div class="accordion taxonomies-toggle"><div class="row card component accordion-item"><div class="accordion-header card-header border-0"><a class="accordion-button d-lg-none mb-1 shadow-none p-0 bg-transparent collapsed" role=button data-bs-toggle=collapse href=#taxonomies-toggle aria-expanded=false aria-controls=taxonomies-toggle>Taxonomies</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block" id=taxonomies-toggle><ul class="nav nav-pills nav-fill" role=tablist><li class=nav-item role=presentation><button class="nav-link active" id=taxonomyCategoriesTab data-bs-toggle=tab data-bs-target=#taxonomyCategories type=button role=tab aria-controls=taxonomyCategories aria-selected=true>
分类</button></li><li class=nav-item role=presentation><button class=nav-link id=taxonomyTagsTab data-bs-toggle=tab data-bs-target=#taxonomyTags type=button role=tab aria-controls=taxonomyTags aria-selected=true>
标签</button></li><li class=nav-item role=presentation><button class=nav-link id=taxonomyArchivesTab data-bs-toggle=tab data-bs-target=#taxonomyArchives type=button role=tab aria-controls=taxonomyArchives aria-selected=true>
归档</button></li></ul><div class="tab-content mt-3"><div class="tab-pane active" id=taxonomyCategories role=tabpanel aria-labelledby=taxonomyCategoriesTab tabindex=0><a href=/myblog/categories/%E6%8A%80%E6%9C%AF/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-category me-2 mb-2" title=技术>技术
<span class="badge badge-sm text-secondary bg-white ms-1">24</span></a>
<a href=/myblog/categories/linux/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-category me-2 mb-2" title=linux>linux
<span class="badge badge-sm text-secondary bg-white ms-1">9</span></a>
<a href=/myblog/categories/java/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-category me-2 mb-2" title=java>java
<span class="badge badge-sm text-secondary bg-white ms-1">8</span></a>
<a href=/myblog/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-category me-2 mb-2" title=操作系统>操作系统
<span class="badge badge-sm text-secondary bg-white ms-1">8</span></a>
<a href=/myblog/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-category me-2 mb-2" title=中间件>中间件
<span class="badge badge-sm text-secondary bg-white ms-1">7</span></a>
<a href=/myblog/categories/spring/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-category me-2 mb-2" title=spring>spring
<span class="badge badge-sm text-secondary bg-white ms-1">3</span></a>
<a href=/myblog/categories/docker/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-category me-2 mb-2" title=docker>docker
<span class="badge badge-sm text-secondary bg-white ms-1">1</span></a>
<a href=/myblog/categories/spring-boot/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-category me-2 mb-2" title=spring-boot>spring-boot
<span class="badge badge-sm text-secondary bg-white ms-1">1</span></a>
<a href=/myblog/categories/spring-cloud/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-category me-2 mb-2" title=spring-cloud>spring-cloud
<span class="badge badge-sm text-secondary bg-white ms-1">1</span></a>
<a href=/myblog/categories/unbutu/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-category me-2 mb-2" title=Unbutu>Unbutu
<span class="badge badge-sm text-secondary bg-white ms-1">1</span></a>
<a href=https://banrenshan.github.io/myblog/categories class="btn btn-sm btn-secondary post-taxonomy ps-3 post-category me-2 mb-2" title=全部>全部
<span class="badge badge-sm text-secondary bg-white ms-1">13</span></a></div><div class=tab-pane id=taxonomyTags role=tabpanel aria-labelledby=taxonomyTagsTab tabindex=0><a href=/myblog/tags/java/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=java>java
<span class="badge badge-sm text-secondary bg-white ms-1">31</span></a>
<a href=/myblog/tags/linux/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=linux>linux
<span class="badge badge-sm text-secondary bg-white ms-1">8</span></a>
<a href=/myblog/tags/%E7%9B%91%E6%8E%A7/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=监控>监控
<span class="badge badge-sm text-secondary bg-white ms-1">4</span></a>
<a href=/myblog/tags/gradle/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=gradle>gradle
<span class="badge badge-sm text-secondary bg-white ms-1">3</span></a>
<a href=/myblog/tags/graphql/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=graphql>graphql
<span class="badge badge-sm text-secondary bg-white ms-1">3</span></a>
<a href=/myblog/tags/spring/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=spring>spring
<span class="badge badge-sm text-secondary bg-white ms-1">3</span></a>
<a href=/myblog/tags/shell/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=shell>shell
<span class="badge badge-sm text-secondary bg-white ms-1">2</span></a>
<a href=/myblog/tags/docker/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=docker>docker
<span class="badge badge-sm text-secondary bg-white ms-1">1</span></a>
<a href=/myblog/tags/filebeat/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=filebeat>filebeat
<span class="badge badge-sm text-secondary bg-white ms-1">1</span></a>
<a href=/myblog/tags/grafana/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=grafana>grafana
<span class="badge badge-sm text-secondary bg-white ms-1">1</span></a>
<a href=https://banrenshan.github.io/myblog/tags class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=全部>全部
<span class="badge badge-sm text-secondary bg-white ms-1">22</span></a></div><div class=tab-pane id=taxonomyArchives role=tabpanel aria-labelledby=taxonomyArchivesTab tabindex=0><a href class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2022>2022 <span class="badge badge-sm text-secondary bg-white ms-1">48</span></a>
<a href class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=0001>0001 <span class="badge badge-sm text-secondary bg-white ms-1">5</span></a></div></div></div></div></div><div class="accordion posts-toggle"><div class="row card component accordion-item"><div class="accordion-header card-header border-0"><a class="accordion-button d-lg-none mb-1 shadow-none p-0 bg-transparent collapsed" role=button data-bs-toggle=collapse href=#posts-toggle aria-expanded=false aria-controls=posts-toggle>文章</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block" id=posts-toggle><ul class="nav nav-pills nav-fill" role=tablist><li class=nav-item role=presentation><button class="nav-link active" id=recent-posts-tab data-bs-toggle=tab data-bs-target=#recent-posts type=button role=tab aria-controls=recent-posts aria-selected=true>
最近文章</button></li></ul><div class="tab-content mt-3"><div class="tab-pane active" id=recent-posts role=tabpanel aria-labelledby=recent-posts-tab tabindex=0><ul class="post-list list-unstyled ms-1"><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/myblog/blog/2022/12/grafana/>Grafana</a><div class="post-meta mt-2"><span class=post-date>2022年12月10日</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/myblog/blog/2022/12/gradle-basic/>Gradle-Basic</a><div class="post-meta mt-2"><span class=post-date>2022年12月2日</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/myblog/blog/2022/12/zero-copy/>Zero-Copy</a><div class="post-meta mt-2"><span class=post-date>2022年12月2日</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/myblog/blog/2022/12/java-lock/>Java-Lock</a><div class="post-meta mt-2"><span class=post-date>2022年12月2日</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/myblog/blog/2022/12/java-log/>Java-Log</a><div class="post-meta mt-2"><span class=post-date>2022年12月2日</span></div></div></div></li></ul></div></div></div></div></div><div class="accordion post-toc d-none d-lg-block"><div class="accordion-item row mb-4 card component" id=postTOC><div class="card-header accordion-header"><h2 class="card-title fs-4 my-2 text-surface d-none d-lg-block">目录</h2><a class="accordion-button d-lg-none mb-1 collapsed shadow-none p-0 bg-transparent" role=button data-bs-toggle=collapse href=#post-toc aria-expanded=false aria-controls=post-toc>目录</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block" id=post-toc><nav id=TableOfContents><ul><li><a href=#故障率和慢速调用率阈值>故障率和慢速调用率阈值</a></li><li><a href=#如何使用>如何使用</a><ul><li><a href=#断路器配置>断路器配置</a></li><li><a href=#使用断路器装扮函数并调用>使用断路器装扮函数并调用</a></li></ul></li></ul><ul><li><a href=#依赖>依赖</a></li><li><a href=#相关配置>相关配置</a></li><li><a href=#注解>注解</a><ul><li><a href=#注解的顺序>注解的顺序</a></li></ul></li><li><a href=#指标端点>指标端点</a><ul><li><a href=#health-端点>health 端点</a></li><li><a href=#events端点>events端点</a></li></ul></li></ul><ul><li><a href=#装扮接口>装扮接口</a></li><li><a href=#装扮器的顺序>装扮器的顺序</a></li><li><a href=#fallback>Fallback</a></li></ul></nav></div></div></div></div></aside></div></main><footer class="footer mt-auto py-3 text-center container"></footer><script data-precache src=/myblog/assets/main/bundle.min.4976817c50e9fbebc65d5da4994ce4fe52de9ef0821503aee57a131f470d190f.js integrity="sha256-SXaBfFDp++vGXV2kmUzk/lLenvCCFQOu5XoTH0cNGQ8=" crossorigin=anonymous async></script><script data-precache src=/myblog/assets/icons/bundle.min.4f30d5267a9f2f9d45ed93969d45ec626100a969a8b91f71f753315a261e9034.js integrity="sha256-TzDVJnqfL51F7ZOWnUXsYmEAqWmouR9x91MxWiYekDQ=" crossorigin=anonymous defer></script>
<script data-precache src=/myblog/assets/viewer/bundle.min.0a0d0099935beee41b7a7bf4543cd55e793e5f830a571b0794ef8c3602c5823c.js integrity="sha256-Cg0AmZNb7uQbenv0VDzVXnk+X4MKVxsHlO+MNgLFgjw=" crossorigin=anonymous defer></script>
<script src=/myblog/js/sw-register.js defer></script></body></html>